<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>每週豆漿團購登記</title>
<style>
:root{
  --radius: 10px; --border:#ddd; --cat:#d9edf7; --hi:#fff7b1;
  --fz-base: clamp(16px, 3vw, 20px);
  --fz-large: clamp(18px, 4vw, 24px);
}
*{box-sizing:border-box}
body{margin:0;background:#fafafa;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans TC",sans-serif;font-size:var(--fz-base);line-height:1.4;}
.wrap{max-width:520px;margin:auto;padding:10px;background:#fff;border:2px solid #000;border-radius:12px;}
h1{font-size:var(--fz-large);margin:4px 0 12px;text-align:center;}
label{display:block;margin-bottom:6px;font-weight:600;}
input[type="text"]{width:100%;padding:8px;font-size:var(--fz-large);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:10px;}

.toolbar{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px;}
.btn{padding:10px 12px;font-size:var(--fz-base);border:1px solid var(--border);background:#fff;border-radius:var(--radius);cursor:pointer;}
.btn:active{transform:scale(.97)}

.cat-header{display:flex;justify-content:space-between;align-items:center;background:var(--cat);padding:6px 8px;border-radius:var(--radius);margin-top:10px;margin-bottom:6px;font-weight:700;}
.cat-header .btn{flex:0 0 auto;}

.item{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:6px;margin-bottom:4px;transition:background .15s;}
.item.highlight{background:var(--hi);}
.name{font-weight:700;margin-bottom:2px;}
.price{margin-bottom:4px;}
.qty{display:flex;align-items:center;gap:6px;}
.qty input{width:70px;padding:6px;font-size:var(--fz-large);text-align:center;border:1px solid var(--border);border-radius:8px;-moz-appearance:textfield;}
.qty input::-webkit-inner-spin-button,.qty input::-webkit-outer-spin-button{-webkit-appearance:none;margin:0;}
.step{padding:6px 10px;font-size:var(--fz-large);border:1px solid var(--border);background:#fff;border-radius:8px;cursor:pointer;}
.subtotal{text-align:right;font-weight:700;margin-top:2px;}

.totals{margin-top:10px;padding:8px;background:#fff;border:1px solid var(--border);border-radius:var(--radius);font-size:var(--fz-large);}
.totals div{margin-bottom:4px;}
.accent{color:#d2691e;font-weight:700;}
.muted{color:#666;font-size:.9em}
.hide-empty .item:not(.highlight){display:none;}
.collapsed{display:none;}

/* 小計模式（截圖精簡清單） */
.summary{display:none;margin-top:10px;}
.summary-mode #catalog{display:none;}
.summary-mode .summary{display:block;}
.summary .sec{border:1px solid var(--border);border-radius:var(--radius);background:#fff;margin-bottom:8px;overflow:hidden;}
.summary .sec-title{background:var(--cat);padding:6px 8px;font-weight:700;}
.summary .row{display:flex;gap:8px;justify-content:space-between;align-items:center;padding:6px 8px;border-top:1px dashed #e6e6e6;}
.summary .left{display:flex;gap:8px;align-items:center;min-width:0;flex-wrap:wrap;}
.summary .name{font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:260px;}
.summary .badge{border:1px solid #e0e0e0;border-radius:6px;padding:2px 6px;background:#fff;}
.summary .qty-badge{font-weight:900;background:#fff7b1;border:1px solid #f0df75;border-radius:6px;padding:2px 8px;}
.summary .money{font-weight:800;}

/* 團購清單 & 總彙總 */
.section{margin-top:12px;padding:10px;border:1px solid var(--border);border-radius:var(--radius);background:#fff;}
.section h2{margin:0 0 8px 0;font-size:1.1em}
.record{border:1px solid #eee;border-radius:8px;padding:8px;margin-bottom:8px;background:#fafafa;}
.record .hdr{display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap;font-weight:700;}
.record .meta{font-weight:400}
.record .details{margin-top:6px;border-top:1px dashed #e6e6e6;padding-top:6px;display:none}
.record.open .details{display:block}
.record table{width:100%;border-collapse:collapse;font-size:.95em}
.record th, .record td{border-bottom:1px solid #eee;padding:4px;text-align:right}
.record th:first-child, .record td:first-child{text-align:left}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid #eee;padding:6px;text-align:right}
.table th:first-child,.table td:first-child{text-align:left}
.table .group{background:#f7f7f7;font-weight:800;}
.bad{color:#a00}
.danger{background:#ffe8e8;border:1px solid #ffbdbd}

/* 列印 */
@media print{
  body{background:#fff}
  .wrap{border:2px solid #000;border-radius:12px}
  .btn,.toolbar{display:none !important;}
  input[type="text"],input[type="number"]{border:none}
  .item{page-break-inside:avoid}
  .section{page-break-inside:avoid}
}
</style>
</head>
<body>
<div class="wrap" id="wrap">
  <h1>每週豆漿團購登記</h1>

  <label for="buyer">訂購人姓名</label>
  <input type="text" id="buyer" placeholder="輸入姓名" />

  <div class="toolbar">
    <button class="btn" id="btn-clear-inputs">清空頁面數量</button>
    <button class="btn" id="btn-toggle">檢視模式</button>
  </div>

  <!-- 目錄 -->
  <div id="catalog">
    <div class="cat-header">
      <span>2500cc 袋裝</span>
      <button class="btn btn-toggle-cat" data-target="cat-2500" aria-expanded="true">收合</button>
    </div>
    <div id="cat-2500"></div>

    <div class="cat-header">
      <span>1050cc 口栓袋</span>
      <button class="btn btn-toggle-cat" data-target="cat-1050" aria-expanded="true">收合</button>
    </div>
    <div id="cat-1050"></div>

    <div class="cat-header">
      <span>330cc 杯裝</span>
      <button class="btn btn-toggle-cat" data-target="cat-330" aria-expanded="true">收合</button>
    </div>
    <div id="cat-330"></div>
  </div>

  <!-- 小計清單 -->
  <div id="summary" class="summary"></div>

  <div class="totals">
    <div>訂購人：<span id="buyer-name"></span></div>
    <div class="muted">統計時間：<span id="ts"></span></div>
    <div>2500cc 小計：$<span id="sub-2500" class="accent">0</span></div>
    <div>1050cc 小計：$<span id="sub-1050" class="accent">0</span></div>
    <div>330cc 小計：$<span id="sub-330"  class="accent">0</span></div>
    <div>總金額：$<span id="grand-total" class="accent">0</span></div>

    <div class="toolbar" style="margin-top:8px">
      <button class="btn" id="btn-add-record">填寫完成/加入至統計表（送雲端）</button>
      <button class="btn" id="btn-bottom-mode">小計模式（截圖使用）/復原檢視模式</button>
    </div>
    <button class="btn danger" id="btn-clear-all" title="清除所有紀錄與輸入">⚠️ 清空頁面數量（僅清本頁，不動雲端）</button>
    <div class="muted">說明：雲端資料請於下方明細逐筆刪除（依權限）。</div>
  </div>

  <!-- 團購清單（雲端資料） -->
  <div class="section" id="records-section">
    <h2>團購清單（雲端即時）</h2>
    <div id="records-list" class="records"></div>
    <div class="muted">點「明細」可展開查看每位填寫者的品項與數量。</div>
  </div>

  <!-- 總彙總（全部雲端紀錄） -->
  <div class="section" id="aggregate-section">
    <h2>目前總彙總（全部紀錄）</h2>
    <table class="table" id="agg-table">
      <thead>
        <tr><th>品項</th><th>單價</th><th>總數量</th><th>總金額</th></tr>
      </thead>
      <tbody id="agg-body"></tbody>
      <tfoot>
        <tr><th>2500cc 小計</th><td></td><td id="agg-q-2500" style="text-align:right"></td><td id="agg-s-2500" style="text-align:right"></td></tr>
        <tr><th>1050cc 小計</th><td></td><td id="agg-q-1050" style="text-align:right"></td><td id="agg-s-1050" style="text-align:right"></td></tr>
        <tr><th>330cc 小計</th><td></td><td id="agg-q-330"  style="text-align:right"></td><td id="agg-s-330"  style="text-align:right"></td></tr>
        <tr><th>總金額</th><td></td><td id="agg-q-all"  style="text-align:right"></td><td id="agg-s-all"  style="text-align:right"></td></tr>
      </tfoot>
    </table>
  </div>
</div>

<script>
/* ---------- 資料 ---------- */
const items2500 = [
  {cat:"2500", name:"微糖豆漿", price:45},
  {cat:"2500", name:"黑豆漿",   price:55},
  {cat:"2500", name:"薏仁漿",   price:50},
  {cat:"2500", name:"米漿",     price:65},
  {cat:"2500", name:"高濃豆漿", price:40},
  {cat:"2500", name:"新/舊無糖", price:45},
];
const items1050 = [
  {cat:"1050", name:"小非基",   price:28},
  {cat:"1050", name:"小無糖",   price:28},
  {cat:"1050", name:"小芝麻",   price:36},
  {cat:"1050", name:"小杏仁",   price:51},
  {cat:"1050", name:"小薏麥",   price:31},
  {cat:"1050", name:"小米漿",   price:36},
  {cat:"1050", name:"小南瓜",   price:48},
  {cat:"1050", name:"小黑牛",   price:40},
  {cat:"1050", name:"小芝微",   price:36},
  {cat:"1050", name:"小杏微",   price:51},
  {cat:"1050", name:"小厚豆",   price:33},
  {cat:"1050", name:"小厚豆(無糖)", price:33},
];
const items330 = [
  {cat:"330", name:"豆漿（有糖）（非基改）", price:13},
  {cat:"330", name:"豆漿（無糖）（非基改）", price:13},
  {cat:"330", name:"5.2 厚豆乳（有糖）（非基改）", price:17},
  {cat:"330", name:"燕麥薏仁（有糖）",           price:17},
  {cat:"330", name:"黑芝麻燕麥（有糖）",         price:17},
  {cat:"330", name:"黑芝麻堅果（減糖）",         price:17},
  {cat:"330", name:"黑芝麻豆漿（減糖）",         price:17},
  {cat:"330", name:"糙米漿（有糖）",             price:17},
  {cat:"330", name:"杏仁漿（有糖）",             price:18},
  {cat:"330", name:"杏仁漿（減糖）",             price:18},
  {cat:"330", name:"南瓜豆漿（有糖）（非基改）",   price:18},
  {cat:"330", name:"紅豆薏仁（有糖）",           price:18},
  {cat:"330", name:"黑芝麻牛奶（有糖）",         price:18},
  {cat:"330", name:"黑豆堅果（減糖）",           price:18},
];
const items=[...items2500,...items1050,...items330];

const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const fmt = n => Number(n).toLocaleString('zh-Hant-TW');
function nowTS(){
  const d = new Date();
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
  const hh=String(d.getHours()).padStart(2,'0'), mm=String(d.getMinutes()).padStart(2,'0');
  return `${y}/${m}/${day} ${hh}:${mm}`;
}

/* ---------- 產出 UI（品項卡） ---------- */
function renderItems(list,wrapId,offset){
  const wrap=document.getElementById(wrapId);
  list.forEach((item,i)=>{
    const idx = offset + i;
    const el=document.createElement('div');
    el.className='item';
    el.dataset.index=idx;
    el.innerHTML=`
      <div class="name">${item.name}</div>
      <div class="price">單價：$${fmt(item.price)}</div>
      <div class="qty">
        <button class="step" data-step="-1">−</button>
        <input type="number" min="0" value="0">
        <button class="step" data-step="1">＋</button>
      </div>
      <div class="subtotal">$<span class="subtotal-num">0</span></div>`;
    wrap.appendChild(el);
  });
}
renderItems(items2500,'cat-2500',0);
renderItems(items1050,'cat-1050',items2500.length);
renderItems(items330,'cat-330',items2500.length+items1050.length);

/* ---------- 計算（頁面） ---------- */
const sub2500=$('#sub-2500'), sub1050=$('#sub-1050'), sub330=$('#sub-330'), grand=$('#grand-total');
const buyerInput=$('#buyer'), buyerName=$('#buyer-name'), tsSpan=$('#ts'), wrapBox=$('#wrap'), summaryBox=$('#summary');

buyerInput.addEventListener('input',()=>buyerName.textContent=buyerInput.value);
function updateTS(){ tsSpan.textContent = nowTS(); }

function recalc(){
  let t2500=0,t1050=0,t330=0;
  $$('.item').forEach(card=>{
    const idx=+card.dataset.index;
    const qty=Math.max(0,parseInt(card.querySelector('input').value||'0',10));
    const subtotal=qty*items[idx].price;
    card.querySelector('.subtotal-num').textContent=fmt(subtotal);
    card.classList.toggle('highlight',qty>0);
    if(items[idx].cat==='2500')t2500+=subtotal;
    else if(items[idx].cat==='1050')t1050+=subtotal;
    else t330+=subtotal;
  });
  sub2500.textContent=fmt(t2500);
  sub1050.textContent=fmt(t1050);
  sub330.textContent=fmt(t330);
  grand.textContent=fmt(t2500+t1050+t330);

  if (wrapBox.classList.contains('summary-mode')) buildSummary();
  updateTS();
}
document.body.addEventListener('input',e=>{
  if(e.target.matches('.item input[type="number"]'))recalc();
});
document.body.addEventListener('click',e=>{
  if(e.target.matches('.step')){
    const input=e.target.parentElement.querySelector('input');
    input.value=Math.max(0,(+input.value||0)+(+e.target.dataset.step));
    recalc();
  }
});
$('#btn-clear-inputs').addEventListener('click',()=>{
  $$('.item input[type="number"]').forEach(i=>i.value=0);
  recalc();
});
$('#btn-toggle').addEventListener('click',()=>wrapBox.classList.toggle('hide-empty'));

/* ---------- 小計模式（精簡清單） ---------- */
let prevCollapsed = {};
$('#btn-bottom-mode').addEventListener('click',()=>{
  if (wrapBox.classList.contains('summary-mode')) exitSummaryMode();
  else enterSummaryMode();
});
function enterSummaryMode(){
  ['cat-2500','cat-1050','cat-330'].forEach(id=>{
    const el=document.getElementById(id); prevCollapsed[id]=el.classList.contains('collapsed'); el.classList.remove('collapsed');
    const btn = document.querySelector(`.btn-toggle-cat[data-target="${id}"]`);
    if (btn){ btn.textContent='收合'; btn.setAttribute('aria-expanded','true'); }
  });
  wrapBox.classList.add('summary-mode'); buildSummary(); updateTS();
}
function exitSummaryMode(){
  wrapBox.classList.remove('summary-mode');
  Object.entries(prevCollapsed).forEach(([id,flag])=>{
    document.getElementById(id).classList.toggle('collapsed',!!flag);
    const btn = document.querySelector(`.btn-toggle-cat[data-target="${id}"]`);
    if (btn){
      btn.textContent = flag ? '展開' : '收合';
      btn.setAttribute('aria-expanded', flag ? 'false' : 'true');
    }
  });
  updateTS();
}
function buildSummary(){
  const cats=[{id:'2500',title:'2500cc 袋裝'},{id:'1050',title:'1050cc 口栓袋'},{id:'330',title:'330cc 杯裝'}];
  summaryBox.innerHTML='';
  cats.forEach(c=>{
    const list=[]; let catSum=0;
    $$('.item').forEach(card=>{
      const idx=+card.dataset.index, qty=parseInt(card.querySelector('input').value||'0',10);
      if(items[idx].cat!==c.id || qty<=0) return;
      const price=items[idx].price, money=qty*price; catSum+=money;
      list.push({name:items[idx].name, price, qty, money});
    });
    if(!list.length) return;
    const sec=document.createElement('div'); sec.className='sec';
    sec.innerHTML=`<div class="sec-title">${c.title}</div>`;
    list.forEach(r=>{
      const row=document.createElement('div'); row.className='row';
      row.innerHTML=`
        <div class="left">
          <span class="name">${r.name}</span>
          <span class="badge">單價 $${fmt(r.price)}</span>
          <span class="qty-badge">數量 ${r.qty}</span>
        </div>
        <div class="money">$${fmt(r.money)}</div>`;
      sec.appendChild(row);
    });
    const sub=document.createElement('div'); sub.className='sec-sub'; sub.textContent=`小計 $${fmt(catSum)}`; sec.appendChild(sub);
    summaryBox.appendChild(sec);
  });
}

/* ---------- 展開/收合 ---------- */
function setCollapsed(targetId, collapsed){
  const panel = document.getElementById(targetId);
  if (!panel) return;
  panel.classList.toggle('collapsed', !!collapsed);
  const btn = document.querySelector(`.btn-toggle-cat[data-target="${targetId}"]`);
  if (btn){
    btn.textContent = collapsed ? '展開' : '收合';
    btn.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
  }
}
$$('.btn-toggle-cat').forEach(btn=>{
  btn.addEventListener('click',()=>{
    if (wrapBox.classList.contains('summary-mode')) exitSummaryMode();
    const id = btn.dataset.target;
    const willCollapse = !document.getElementById(id).classList.contains('collapsed');
    setCollapsed(id, willCollapse);
  });
});

/* ---------- 建立提交資料 ---------- */
function getQuantities(){
  const q=[]; $$('.item').forEach(card=>q.push(parseInt(card.querySelector('input[type="number"]').value||'0',10)||0));
  return q;
}
function buildRecord(){
  const quantities=getQuantities();
  const ts = nowTS();
  const buyer = ($('#buyer')?.value.trim()) || '（未填姓名）';
  const itemsPicked=[];
  let sum2500=0,sum1050=0,sum330=0, grand=0;

  quantities.forEach((qty,idx)=>{
    if(qty<=0) return;
    const it=items[idx];
    const money=qty*it.price;
    itemsPicked.push({idx, name:it.name, cat:it.cat, price:it.price, qty, money});
    if(it.cat==='2500') sum2500+=money;
    else if(it.cat==='1050') sum1050+=money;
    else sum330+=money;
    grand+=money;
  });

  return { buyer, ts, items:itemsPicked, sum:{'2500':sum2500,'1050':sum1050,'330':sum330, grand} };
}
</script>

<!-- ===== Firebase（以 <script type="module"> 匯入） ===== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getFirestore, collection, addDoc, serverTimestamp,
           query, orderBy, onSnapshot, getDocs, deleteDoc, doc } 
    from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  /* ① 將下方換成你的 firebaseConfig（從 Console 複製） */
  const firebaseConfig = {
    apiKey: "AIzaSyBDtSRcMhjLUqzU_BS9p3bFaqT2nZc4lu8",
    authDomain: "order-c9c29.firebaseapp.com",
    projectId: "order-c9c29",
    storageBucket: "order-c9c29.firebasestorage.app",
    messagingSenderId: "596005686391",
    appId: "1:596005686391:web:2795ea118834b749214a72",
    measurementId: "G-Z3PHZMCGNW"
  };


  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  /* ② 送單：把本次填寫寫入 Firestore */
  document.getElementById('btn-add-record').addEventListener('click', async ()=>{
    const rec = buildRecord();
    if(!rec.items.length){ alert('目前沒有填寫任何數量。'); return; }
    try{
      await addDoc(collection(db, 'orders'), {
        buyer: rec.buyer,
        ts: rec.ts,
        items: rec.items,
        sum_2500: rec.sum['2500'],
        sum_1050: rec.sum['1050'],
        sum_330:  rec.sum['330'],
        grand:    rec.sum.grand,
        created_at: serverTimestamp()
      });
      alert('已提交到雲端！');
      // 清空頁面數量
      document.querySelectorAll('.item input[type="number"]').forEach(i=>i.value=0);
      recalc();
    }catch(err){
      alert('提交失敗：' + err.message);
    }
  });

  /* ③ 即時監聽 orders → 渲染列表與彙總 */
  function subscribeOrders(callback){
    const q = query(collection(db,'orders'), orderBy('created_at','desc'));
    return onSnapshot(q, snap=>{
      const rows = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      callback(rows);
    });
  }

  function renderRecordsCloud(rows){
  const listEl = document.getElementById('records-list');
  if(!rows.length){
    listEl.innerHTML = '<div class="muted">尚無紀錄，請先在上方輸入並按「填寫完成」。</div>';
    renderAggregateCloud([]); 
    return;
  }
  listEl.innerHTML = '';

  rows.forEach((rec)=>{
    const card=document.createElement('div'); 
    card.className='record';
    card.innerHTML=`
      <div class="hdr">
        <div>${rec.buyer} <span class="meta">（${rec.ts||''}）</span></div>
        <div>總金額 $${fmt(rec.grand||0)}</div>
      </div>
      <div class="muted">2500小計 $${fmt(rec.sum_2500||0)} ｜ 1050小計 $${fmt(rec.sum_1050||0)} ｜ 330小計 $${fmt(rec.sum_330||0)}</div>
      <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap">
        <button class="btn btn-toggle-detail">明細</button>
        <button class="btn bad btn-del-record" data-id="${rec.id}">刪除此筆</button>
      </div>
      <div class="details">
        <table>
          <thead><tr><th>品項</th><th>單價</th><th>數量</th><th>小計</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>`;

    const tbody = card.querySelector('tbody');
    (rec.items||[]).forEach(it=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td style="text-align:left">${it.name}</td><td>$${fmt(it.price)}</td><td>${fmt(it.qty)}</td><td>$${fmt(it.money)}</td>`;
      tbody.appendChild(tr);
    });

    card.querySelector('.btn-toggle-detail').addEventListener('click',()=>card.classList.toggle('open'));

    card.querySelector('.btn-del-record').addEventListener('click', async (ev)=>{
      const id = ev.currentTarget.getAttribute('data-id');
      const word = prompt(`⚠️ 確定要刪除這筆紀錄嗎？\n請輸入「刪除」以確認：`);
      if(word !== "刪除") {
        alert("已取消刪除。");
        return;
      }
      try {
        await deleteDoc(doc(db, 'orders', id));
        alert("✅ 已刪除！");
      } catch(e){
        alert('❌ 刪除失敗：' + e.message);
      }
    });

    listEl.appendChild(card);
  });

  renderAggregateCloud(rows);
}


  function renderAggregateCloud(rows){
    const tbody = document.getElementById('agg-body'); if(!tbody) return;
    tbody.innerHTML='';
    const qByKey = {}; // key = cat::name::price
    const sumByCat = {'2500':0,'1050':0,'330':0};
    let qtyAll=0,sumAll=0;

    rows.forEach(r=>{
      (r.items||[]).forEach(it=>{
        const key = `${it.cat}:::${it.name}:::${it.price}`;
        qByKey[key] = (qByKey[key]||0) + it.qty;
        sumByCat[it.cat] += it.money;
        qtyAll += it.qty; sumAll += it.money;
      });
    });

    const cats = [
      {id:'2500', title:'2500cc 袋裝'},
      {id:'1050', title:'1050cc 口栓袋'},
      {id:'330',  title:'330cc 杯裝'}
    ];
    cats.forEach(c=>{
      const th = document.createElement('tr'); th.className='group'; th.innerHTML=`<td colspan="4">${c.title}</td>`;
      tbody.appendChild(th);
      let hasAny=false;
      Object.entries(qByKey).forEach(([k,qty])=>{
        const [cat,name,price] = k.split(':::'); if(cat!==c.id || qty<=0) return;
        hasAny=true;
        const money = qty * Number(price);
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${name}</td><td>$${fmt(price)}</td><td>${fmt(qty)}</td><td>$${fmt(money)}</td>`;
        tbody.appendChild(tr);
      });
      if(!hasAny){
        const tr=document.createElement('tr');
        tr.innerHTML=`<td colspan="4" class="muted">（此分類目前無數量）</td>`;
        tbody.appendChild(tr);
      }
    });

    document.getElementById('agg-q-2500').textContent = '';
    document.getElementById('agg-q-1050').textContent = '';
    document.getElementById('agg-q-330').textContent  = '';
    document.getElementById('agg-s-2500').textContent = `$${fmt(sumByCat['2500'])}`;
    document.getElementById('agg-s-1050').textContent = `$${fmt(sumByCat['1050'])}`;
    document.getElementById('agg-s-330').textContent  = `$${fmt(sumByCat['330'])}`;
    document.getElementById('agg-q-all').textContent  = fmt(qtyAll);
    document.getElementById('agg-s-all').textContent  = `$${fmt(sumAll)}`;
  }

  // 啟用即時監聽
  subscribeOrders(renderRecordsCloud);

  /* ④ 僅清空本頁輸入，不動雲端 */
  document.getElementById('btn-clear-all').addEventListener('click',()=>{
    document.querySelectorAll('.item input[type="number"]').forEach(i=>i.value=0);
    recalc();
    alert('已清空本頁數量（雲端資料未變動）。');
  });

  // 初始顯示
  document.getElementById('ts').textContent = nowTS();
  const buyerInput=document.getElementById('buyer'); document.getElementById('buyer-name').textContent = buyerInput.value || '';
  recalc();
</script>
</body>
</html>
