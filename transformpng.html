<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>追思祝福場次匯出 PNG</title>

<!-- html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
  /* === 字體與主題變數 ===================== */
  @font-face{
    font-family: "Microsoft JhengHei";
    src: local("Microsoft JhengHei"), local("微軟正黑體");
    font-weight: 400;
    font-style: normal;
  }
  :root{
    --accent:#b40000;
    --muted:#666;
    --panel:#ffffff;
    --highlight:#fff4e6;
    --strong-note-bg:#fff1f0;
    --backdrop: rgba(0,0,0,.45);
  }
  *{box-sizing:border-box}
  body{font-family:"Microsoft JhengHei","Noto Sans TC","PingFang TC",Arial,sans-serif;background:#f2f4f7;margin:18px;color:#111}
  .wrap{max-width:1180px;margin:0 auto}
  h1{font-size:20px;margin:0 0 12px 0}
  .container{display:grid;grid-template-columns:420px 1fr;gap:18px}
  .card{background:var(--panel);border-radius:8px;padding:14px;border:1px solid #e6e6e6;box-shadow:0 6px 18px rgba(0,0,0,0.03)}
  label{display:block;margin:6px 0 6px;color:var(--muted);font-size:16px}
  input[type="text"], input[type="date"], select, textarea {width:100%;padding:8px;border:1px solid #d0d0d0;border-radius:6px;font-size:14px;font-family:inherit}
  textarea{resize:vertical}
  button{padding:8px 12px;border-radius:6px;border:1px solid #bbb;background:#fff;cursor:pointer;font-family:inherit}
  button.primary{background:var(--accent);color:#fff;border-color:rgba(0,0,0,0.06)}
  .small{font-size:13px;color:var(--muted)}
  .controls{display:flex;flex-direction:column;gap:12px}
  .row{display:flex;gap:8px}
  .row> *{flex:1}
  .btn-row{display:flex;gap:8px;justify-content:space-between;align-items:center}

  /* 預覽 / 匯出區 */
  #exportArea{width:880px;background:var(--highlight);border:3px solid #d8c9a3;padding:18px;box-sizing:border-box;color:#222;position:relative}
  .headerRow{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;position:relative}
  #dynamicTitle{
    font-size:34px;
    font-weight:700;
    line-height:1.05;
    margin-bottom:6px;
    text-align:center;
  }
  #dynamicTitle .datePart{color:var(--accent);margin-right:6px}
  #dynamicTitle .titlePhrase{color:#000}

  /* 溫馨提醒徽章（第4點） */
  #reminderBadge{
    position:absolute;
    left:0; top:0;
    transform:translateY(-6px);
    background:#ffdfe0;
    border:1px solid #f2a8ad;
    color:#b40000;
    border-radius:999px;
    padding:4px 10px;
    font-size:14px;
    font-weight:700;
    display:none; /* JS 依勾選顯示 */
    box-shadow:0 2px 6px rgba(0,0,0,.06);
  }

  .metaBox{border:2px solid #dcd0b8;padding:10px;background:#fff;margin-top:12px}
  .meta-left{display:flex;flex-direction:column;gap:6px;align-items:flex-start}
  .meta-left .time-line,
  .meta-left .loc-line{font-size:20px;font-weight:700} /* 標籤字級一致（第7點） */
  .metaValue{color:#b40000;font-size:150%;font-weight:900;margin-left:4px} /* 值：紅+1.5x（第8點） */

  /* ✅ 固定欄寬的關鍵：table-layout: fixed，讓六欄平均 */
  table.regTable{
    width:100%;
    border-collapse:collapse;
    margin-top:12px;
    table-layout: fixed;
  }
  table.regTable td{
    border:1px solid #9a8f7a;
    padding:10px;
    font-size:20px;
    height:48px;
    vertical-align:middle;
    text-align:center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  table.regTable td.empty{color:#bbb}
  td.totalCell{font-weight:700;color:var(--accent);background:#fff6f6}
  .roleSuffix{font-size:12px;color:#444;margin-left:6px}
  .fullNote{margin-top:12px;padding:10px;background:var(--strong-note-bg);border-left:6px solid #f5c0c0;font-weight:700;color:#990000;text-align:center}
  /* 缺額訊息（第2–3點） */
  #deficitNote{display:none;margin-top:12px;padding:10px;background:#fff7f7;border-left:6px solid #f0a0a0;font-weight:700;color:#b40000;text-align:center}
  #deficitNote .num{font-size:150%;color:#b40000;font-weight:900}

  .instruction{margin-top:8px;font-size:13px;color:var(--muted)}
  .registration-list{max-height:260px;overflow:auto;border:1px dashed #e0e0e0;padding:8px;border-radius:6px;background:#fafafa}
  .reg-item{display:flex;justify-content:space-between;padding:6px 4px;border-bottom:1px solid #eee;font-size:14px}
  .reg-item:last-child{border-bottom:none}

  .checkbox-row{display:flex;align-items:center;gap:8px}
  .role-fixed{background:#fffef7;padding:6px;border-radius:6px;margin-bottom:6px;font-size:14px}

  /* 人力狀態容器（把原checkbox改成單選群組仍維持相近外觀） */
  .status-row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
  .status-row .option{display:flex;align-items:center;gap:6px;padding:6px 8px;border:1px solid #e5e5e5;border-radius:8px;background:#fff}

  /* 右下角版本標註 */
  .version-tag{
    position:fixed;
    right:12px;
    bottom:10px;
    font-size:12px;
    color:#888;
    user-select:none;
    pointer-events:none;
  }

  /* RWD */
  @media (max-width:1000px){
    .container{grid-template-columns:1fr; padding:8px}
    #exportArea{width:100%}
    #dynamicTitle{font-size:26px}
    #reminderBadge{transform:none}
  }

  /* === 匯出「離屏舞台」與捕捉模式 ===================== */
  .capture-stage{
    position:fixed;
    left:-100000px;
    top:0;
    width:1px;
    height:1px;
    overflow:hidden;
    pointer-events:none;
    z-index:-1;
  }
  .capture-root{
    width:880px;
    margin:0;
  }
  /* 匯出圖字體：標楷體 + 粗體（第6點） */
  .capture-root, .capture-root *{
    font-family:"DFKai-SB","標楷體",serif !important;
    font-weight: bold !important;
    line-height:1.2;
  }
  body.capture-mode #exportArea{
    width:880px !important;
  }



  /* === UA 提示條（LINE/FB/IG 內建瀏覽器） ================= */
  #uaNotice{
    display:none;
    position:sticky;
    top:0;
    z-index:1000;
    background:#fff8e1;
    color:#7a3e00;
    border:1px solid #f0c070;
    border-radius:8px;
    padding:10px 12px;
    margin:0 0 12px 0;
  }
  #uaNotice .actions{
    display:flex;gap:8px;flex-wrap:wrap;margin-top:6px
  }
  #uaNotice button{
    border-color:#e0b056;
  }

  /* === 匯出預覽 Modal（長按存圖 / 分享 / 複製） ============ */
  .modal-backdrop{
    position:fixed;inset:0;background:var(--backdrop);
    display:none;
    align-items:center;justify-content:center;
    z-index:2000;
    padding:16px;
  }
  .modal-backdrop.open{display:flex}
  .modal{
    background:#fff;border-radius:12px;border:1px solid #e5e5e5;
    max-width:min(100%,960px);width:100%;
    max-height:90vh;overflow:auto;padding:14px;
    box-shadow:0 10px 30px rgba(0,0,0,.15);
  }
  .modal header{
    display:flex;align-items:center;justify-content:space-between;margin-bottom:8px
  }
  .modal header .title{font-weight:700}
  .modal .preview{
    display:flex;justify-content:center;align-items:center;margin:10px 0
  }
  .modal .preview img{
    max-width:100%;height:auto;display:block;border:1px solid #eee;border-radius:8px;background:#fff
  }
  .modal .tips{
    font-size:13px;color:#666;margin:8px 0 12px
  }
  .modal .actions{
    display:flex;gap:8px;flex-wrap:wrap
  }

  /* 使用說明（第11–12點，摺疊樣式） */
  .usage-wrap{margin:8px 0 10px}
  details.usage{background:#fff;border:1px dashed #e5e5e5;border-radius:8px;padding:10px}
  details.usage summary{cursor:pointer;font-weight:700;list-style:none}
  details.usage summary::-webkit-details-marker{display:none}
  .usage .content{font-size:13px;line-height:1.6;color:#333;margin-top:6px}

  .sr-only{
    position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;
  }

  /* 地點下拉項目視覺（第15點） */
  #evLocationSelect option{padding:4px 6px;letter-spacing:.02em}
</style>
</head>
<body>
<!-- UA 提示條（僅在 LINE/FB/IG 內建瀏覽器由 JS 顯示） -->
<div id="uaNotice" role="region" aria-label="環境提示">
  <div style="font-weight:700">提示：此環境可能限制直接下載圖片</div>
  <div class="small">建議改以外部瀏覽器開啟（Safari / Chrome），或匯出後以「長按圖片存圖」方式保存。</div>
  <div class="actions" aria-label="操作">
    <button id="uaOpenExternBtn" type="button">嘗試在外部開啟</button>
    <button id="uaDismissBtn" type="button">知道了</button>
  </div>
</div>

<div class="wrap">
  <!-- H1 文案（第10點） -->
  <h1>「追思祝福」護持菩薩報名名單匯出為圖片檔（請以桌機電腦、手機的 Chrome 或 Safari 瀏覽器開啟，若直接以 LINE 中的瀏覽功能開啟，將無法正常產生圖片）</h1>

  <!-- 使用說明（第11–12點：預設收合，手機友善） -->
  <div class="usage-wrap">
    <details class="usage">
      <summary>使用說明：</summary>
      <div class="content">
        匯出圖片功能為單機版功能，無法多人共同編輯、更新場次資料。若要從上次維護的資料中繼續作業，則須使用同一支手機（平板）或電腦才能繼續編輯或更新。
      </div>
    </details>
  </div>

  <div class="container">
    <!-- 控制面板 -->
    <div class="card">
      <div class="controls">
        <div>
          <div style="font-weight:700;margin-bottom:8px">建立 / 編輯場次</div>
          <label>日期</label>
          <input type="date" id="evDate" />
          <div class="row" style="margin-top:6px">
            <div>
              <label>時</label>
              <select id="evHour"></select>
            </div>
            <div>
              <label>分 (10 分刻度)</label>
              <select id="evMin"></select>
            </div>
          </div>

          <label style="margin-top:8px">集合地點</label>
          <select id="evLocationSelect"></select>
          <input id="evLocationOther" placeholder="若選「其他」，請輸入地點" style="display:none;margin-top:6px"/>

          <!-- 新增：需求總人數（第1點） -->
          <label style="margin-top:8px">需求總人數</label>
          <select id="evRequiredTotal"></select>

          <div style="margin-top:10px" class="btn-row">
            <button id="createEventBtn" class="primary">建立場次</button>
            <button id="updateEventBtn">更新場次</button>
            <button id="deleteEventBtn" style="color:#b00">刪除場次</button>
          </div>
          <div class="small" style="margin-top:6px">建立後會加入下方場次清單（本測試為本機暫存）</div>
        </div>

        <hr style="border:none;border-top:1px dashed #e6e6e6"/>

        <div>
          <div style="font-weight:700;margin-bottom:8px">維護：固定名單（會隨場次儲存）</div>
          <div class="small">填好一次會儲存在該場次，顯示順序：維那 → 木魚 → 代說法 → 場控1..5</div>

          <!-- 標籤改字：維挪→維那（第5點；ID 不變） -->
          <label style="margin-top:8px">維那姓名</label>
          <input id="role_weina" placeholder="維那姓名 (例如 王大明)" />

          <label style="margin-top:8px">木魚姓名</label>
          <input id="role_muyu" placeholder="木魚姓名" />

          <label style="margin-top:8px">代說法姓名</label>
          <input id="role_speaker" placeholder="代說法姓名" />

          <label style="margin-top:8px">場控姓名（1）</label>
          <input id="role_stage1" placeholder="場控1" />

          <label style="margin-top:8px">場控姓名（2）</label>
          <input id="role_stage2" placeholder="場控2" />

          <label style="margin-top:8px">場控姓名（3）</label>
          <input id="role_stage3" placeholder="場控3" />

          <label style="margin-top:8px">場控姓名（4）</label>
          <input id="role_stage4" placeholder="場控4" />

          <label style="margin-top:8px">場控姓名（5）</label>
          <input id="role_stage5" placeholder="場控5" />

          <div style="margin-top:10px" class="btn-row">
            <button id="saveRolesBtn">儲存固定名單到場次</button>
            <button id="clearRolesBtn">清除固定名單</button>
          </div>
        </div>

        <hr style="border:none;border-top:1px dashed #e6e6e6"/>

        <div>
          <div style="font-weight:700;margin-bottom:8px">選取場次 / 報名管理</div>
          <label>場次列表</label>
          <select id="eventSelect"></select>

          <label style="margin-top:8px">加入報名者（逗號、頓號、換行皆視為分隔）</label>
          <textarea id="namesInput" placeholder="張三, 李四、王五 或每行一個" style="height:80px"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="addNamesBtn">加入名單</button>
            <button id="clearNamesBtn">清空名單</button>
            <button id="removeSelectedBtn">刪除勾選名單</button>
          </div>

          <div style="margin-top:10px">
            <label class="small">目前報名（固定名單會顯示於上方）</label>
            <div id="fixedRolesArea" class="role-fixed"></div>
            <div class="registration-list" id="registrationList"></div>
          </div>
        </div>

        <hr style="border:none;border-top:1px dashed #e6e6e6"/>

        <div>
          <div style="font-weight:700;margin-bottom:8px">匯出設定</div>

          <!-- 改為單選群組：不顯示 / 人力已圓滿 / 顯示缺額（第2點） -->
          <div class="status-row" role="radiogroup" aria-label="人力狀態">
            <label class="option"><input type="radio" name="statusMode" value="none" checked> 不顯示人力狀態</label>
            <label class="option"><input type="radio" name="statusMode" value="full"> 勾選：人力已圓滿</label>
            <label class="option"><input type="radio" name="statusMode" value="deficit"> 勾選：顯示本場次護持人數缺額</label>
          </div>

          <!-- 新增：溫馨提醒（第4點） -->
          <div class="checkbox-row" style="margin-top:8px">
            <input type="checkbox" id="reminderCheckbox">
            <label for="reminderCheckbox">勾選：溫馨提醒（匯出圖左上角顯示「溫馨提醒」圖示）</label>
          </div>

          <div style="margin-top:8px">
            <label>輸出檔名</label>
            <input id="outputName" placeholder="event-2025-09-02" />
          </div>
          <div style="margin-top:10px;display:flex;gap:8px">
            <button id="exportBtn" class="primary">匯出 PNG</button>
            <button id="downloadPreviewBtn">下載目前預覽</button>
          </div>
          <div id="status" class="small" style="margin-top:8px"></div>
        </div>
      </div>
    </div>

    <!-- 預覽 / 匯出區 -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:700">匯出預覽（將轉成 PNG）</div>
        <div class="small">輸出為 PNG • 解析度 2×（固定）</div>
      </div>

      <div id="exportArea" aria-label="匯出預覽">
        <div class="headerRow">
          <!-- 溫馨提醒徽章（第4點，JS 控制顯示/隱藏） -->
          <div id="reminderBadge">溫馨提醒</div>

          <div id="dynamicTitle" aria-hidden="true"></div>
        </div>

        <div class="metaBox" style="margin-top:12px;display:flex;align-items:flex-start;justify-content:space-between">
          <div class="meta-left">
            <div class="time-line">集合時間：<span id="metaTime" class="metaValue">10:30</span></div>
            <div class="loc-line">集合地點：<span id="metaLocation" class="metaValue">懷愛館景行樓3樓・至仁1廳</span></div>
          </div>
          <div style="width:220px"></div>
        </div>

        <table class="regTable" aria-label="報名表格">
          <tbody id="regBody"></tbody>
        </table>

        <!-- 人力狀態訊息（與 statusMode 互斥顯示） -->
        <div id="fullNote" class="fullNote" style="display:none;
            font-size:20px;">人力已圓滿，感恩護持！</div>
        <div id="deficitNote" style="display:none;
            font-size:20px;">尚須<span class="num">0</span>位菩薩護持，感恩！</div>

        <div style="margin-top:12px;padding:10px;background:#fff7e6;border-left:6px solid #f0c070;font-weight:700;color:#7a3e00;text-align:center;
            font-size:20px;">
          請穿著義工服、黑襪、黑鞋、戴口罩，帶海青。
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 右下角版本標註 -->
<div class="version-tag">三寶弟子 | 製作日期：2025/09/15 | 版本：V2.0（更新於 2025/09/16）</div>
<script>
/* ---------- 地點下拉清單（原樣保留；實際顯示時做格式化） ---------- */
const LOCATION_LIST = [
"懷愛館景仰樓1F至真1廳","懷愛館景仰樓1F至真2廳","懷愛館景仰樓1F至真3廳",
"懷愛館景仰樓2F至善1廳","懷愛館景仰樓2F至善2廳","懷愛館景仰樓2F至善3廳","懷愛館景仰樓2F至善4廳",
"懷愛館景仰樓3F至美1廳","懷愛館景仰樓3F至美2廳","懷愛館景仰樓3F至美3廳","懷愛館景仰樓3F至美4廳",
"懷愛館景行樓1F景明廳","懷愛館景行樓1F至忠1廳","懷愛館景行樓1F至忠2廳","懷愛館景行樓1F至忠3廳","懷愛館景行樓1F至忠4廳",
"懷愛館景行樓2F至孝1廳","懷愛館景行樓2F至孝2廳","懷愛館景行樓2F至孝3廳","懷愛館景行樓2F至孝4廳",
"懷愛館景行樓3F至仁1廳","懷愛館景行樓3F至仁2廳","懷愛館景行樓3F至仁3廳","懷愛館景行樓3F至仁4廳",
"懷愛館景行樓4F至愛2廳","懷愛館景行樓4F至愛3廳","懷愛館景行樓4F至愛4廳",
"其他"
];

/* ---------- DOM refs（新增必要元素） ---------- */
const evDate = document.getElementById('evDate');
const evHour = document.getElementById('evHour');
const evMin = document.getElementById('evMin');
const evLocationSelect = document.getElementById('evLocationSelect');
const evLocationOther = document.getElementById('evLocationOther');
const evRequiredTotal = document.getElementById('evRequiredTotal'); // 新增：需求總人數

const createEventBtn = document.getElementById('createEventBtn');
const updateEventBtn = document.getElementById('updateEventBtn');
const deleteEventBtn = document.getElementById('deleteEventBtn');
const eventSelect = document.getElementById('eventSelect');
const registrationList = document.getElementById('registrationList');
const namesInput = document.getElementById('namesInput');
const addNamesBtn = document.getElementById('addNamesBtn');
const clearNamesBtn = document.getElementById('clearNamesBtn');
const removeSelectedBtn = document.getElementById('removeSelectedBtn');
const exportBtn = document.getElementById('exportBtn');
const downloadPreviewBtn = document.getElementById('downloadPreviewBtn');
const metaTime = document.getElementById('metaTime');
const metaLocation = document.getElementById('metaLocation');
const regBody = document.getElementById('regBody');
const outputName = document.getElementById('outputName');
const status = document.getElementById('status');

/* 單選狀態（取代原 checkbox 防呆） */
const statusModeRadios = document.querySelectorAll('input[name="statusMode"]'); // none/full/deficit
const reminderCheckbox = document.getElementById('reminderCheckbox'); // 溫馨提醒

/* 預覽區新增元素 */
const fullNote = document.getElementById('fullNote');
const deficitNote = document.getElementById('deficitNote');
const dynamicTitle = document.getElementById('dynamicTitle');
const fixedRolesArea = document.getElementById('fixedRolesArea');
const reminderBadge = document.getElementById('reminderBadge');

/* role inputs（維那 label 已改字，ID 保持，以免影響既有程式） */
const role_weina = document.getElementById('role_weina');
const role_muyu = document.getElementById('role_muyu');
const role_speaker = document.getElementById('role_speaker');
const role_stage1 = document.getElementById('role_stage1');
const role_stage2 = document.getElementById('role_stage2');
const role_stage3 = document.getElementById('role_stage3');
const role_stage4 = document.getElementById('role_stage4');
const role_stage5 = document.getElementById('role_stage5');
const saveRolesBtn = document.getElementById('saveRolesBtn');
const clearRolesBtn = document.getElementById('clearRolesBtn');

/* ---------- UA / Modal refs ---------- */
const uaNotice = document.getElementById('uaNotice');
const uaOpenExternBtn = document.getElementById('uaOpenExternBtn');
const uaDismissBtn = document.getElementById('uaDismissBtn');
const exportModal = document.getElementById('exportModal');
const exportModalClose = document.getElementById('exportModalClose');
const exportImg = document.getElementById('exportImg');
const shareImageBtn = document.getElementById('shareImageBtn');
const copyImageBtn = document.getElementById('copyImageBtn');
const openDataUrlBtn = document.getElementById('openDataUrlBtn');

/* ---------- 本地儲存（沿用；不改函式簽名） ---------- */
const LS_KEY = 'event_png_tool_v1';
function saveToStorage(){
  try {
    localStorage.setItem(LS_KEY, JSON.stringify(events));
    status.textContent = '已自動儲存（本機）';
  } catch(e){
    console.warn('localStorage 失敗', e);
  }
}
function loadFromStorage(){
  try {
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return null;
    const parsed = JSON.parse(raw);
    if(Array.isArray(parsed)) return parsed;
  } catch(e){
    console.warn('localStorage 讀取失敗', e);
  }
  return null;
}

/* ---------- 事件本地暫存：擴充欄位 ---------- */
let events = loadFromStorage() || [];
/* 每筆 event 會包含：
{
  id, date, time, location,
  roles: {...},
  registrants: [],
  requiredTotal: number|null,   // 新增
  statusMode: 'none'|'full'|'deficit', // 新增
  showReminder: boolean         // 新增
}
*/

/* ---------- helpers ---------- */
function splitNamesInput(text){
  if(!text) return [];
  const unified = text.replace(/、/g, ',').replace(/;/g, ',').replace(/\r\n/g, '\n').replace(/\r/g, '\n');
  const parts = unified.split(/[\n,]+/).map(s => s.trim()).filter(Boolean);
  return parts;
}

/* 地點格式化：F→樓、加入「・」分隔（第14–15點） */
function formatLocationForDisplay(str){
  if(!str || str === '其他') return str || '';
  let s = String(str);

  // F -> 樓
  s = s.replace(/(\d)\s*F/gi, '$1樓');

  // 在「懷愛館」與後面的樓棟名稱間加入「・」
  s = s.replace('懷愛館景', '懷愛館・景');

  // 在 樓 與 廳 別前加入「・」：常見「樓至」「樓景」
  s = s.replace('樓至', '樓・至').replace('樓景', '樓・景');

  // 若仍未有最後的「・」且含「至」字樣，可保險補一道（避免少數未命中的樣式）
  if(!/・/.test(s) && /至/.test(s)){
    s = s.replace('至', '・至');
  }

  // 去除多餘空白
  s = s.replace(/\s+/g,'');
  return s;
}

/* 取得目前單選狀態值 */
function getStatusMode(){
  let val = 'none';
  statusModeRadios.forEach(r => { if(r.checked) val = r.value; });
  return val;
}

/* ---------- UI helper functions ---------- */
function refreshEventSelect(){
  eventSelect.innerHTML = '';
  events.forEach((ev, idx) => {
    const o = document.createElement('option');
    o.value = idx;
    o.text = `${ev.date} ${ev.time} — ${ev.location}`; // location 已存格式化後字串
    eventSelect.appendChild(o);
  });
  if(events.length>0){
    eventSelect.value = 0;
    loadEventToForm(0);
    updatePreview(0);
  } else {
    evDate.value = '';
    evHour.value = '';
    evMin.value = '';
    evLocationSelect.value = '';
    evLocationOther.value = '';
    evLocationOther.style.display = 'none';
    evRequiredTotal.value = '';
    metaTime.textContent = '';
    metaLocation.textContent = '';
    renderEmptyGrid();
  }
}

function loadEventToForm(index){
  const ev = events[index];
  if(!ev) return;
  evDate.value = ev.date || '';
  const [hh,mm] = (ev.time || ':').split(':');
  evHour.value = (hh || '').toString().padStart(2,'0');
  evMin.value = (mm || '').toString().padStart(2,'0');

  // 地點：將「已格式化字串」反查是否在清單（不強求完全相同，以 '其他' 顯示並帶入文字）
  const rawMatch = LOCATION_LIST.find(src => formatLocationForDisplay(src) === ev.location);
  if(rawMatch){
    evLocationSelect.value = rawMatch;
    evLocationOther.style.display = 'none';
    evLocationOther.value = '';
  } else if(ev.location === '其他'){
    evLocationSelect.value = '其他';
    evLocationOther.style.display = 'block';
    evLocationOther.value = '';
  } else {
    evLocationSelect.value = '其他';
    evLocationOther.style.display = 'block';
    evLocationOther.value = ev.location || '';
  }

  // 需求總人數
  evRequiredTotal.value = ev.requiredTotal ? String(ev.requiredTotal) : '';

  // 狀態單選
  const mode = ev.statusMode || 'none';
  statusModeRadios.forEach(r => r.checked = (r.value === mode));

  // 溫馨提醒
  reminderCheckbox.checked = !!ev.showReminder;

  // 角色
  const roles = ev.roles || {};
  role_weina.value = roles.weina || '';
  role_muyu.value = roles.muyu || '';
  role_speaker.value = roles.speaker || '';
  role_stage1.value = roles.stage1 || '';
  role_stage2.value = roles.stage2 || '';
  role_stage3.value = roles.stage3 || '';
  role_stage4.value = roles.stage4 || '';
  role_stage5.value = roles.stage5 || '';

  outputName.value = ev.date ? `event-${ev.date}` : '';
  renderRegistrationList(index);
}

function renderRegistrationList(index){
  const ev = events[index] || {roles:{}, registrants:[]};
  registrationList.innerHTML = '';
  const roles = ev.roles || {};
  const roleOrder = [
    {key:'weina', label:'維那'},
    {key:'muyu', label:'木魚'},
    {key:'speaker', label:'代說法'},
    {key:'stage1', label:'場控'},
    {key:'stage2', label:'場控'},
    {key:'stage3', label:'場控'},
    {key:'stage4', label:'場控'},
    {key:'stage5', label:'場控'}
  ];
  let fixedHtml = '';
  roleOrder.forEach(r => {
    const n = roles[r.key];
    if(n && n.trim()){
      fixedHtml += `<div style="margin-bottom:4px;"><strong>${escapeHtml(n)}</strong><span style="font-size:12px;color:#666;margin-left:6px">(${r.label})</span></div>`;
    }
  });
  fixedRolesArea.innerHTML = fixedHtml || '<span class="small">（尚無固定名單）</span>';

  (ev.registrants || []).forEach((name, i) => {
    const div = document.createElement('div'); div.className='reg-item';
    const left = document.createElement('div'); left.textContent = name;
    const right = document.createElement('div');
    const chk = document.createElement('input'); chk.type='checkbox'; chk.dataset.idx = i;
    const del = document.createElement('button'); del.textContent='刪除'; del.style.marginLeft='8px';
    del.addEventListener('click', ()=> {
      if(confirm(`確定刪除 ${name}？`)){
        ev.registrants.splice(i,1);
        renderRegistrationList(index);
        updatePreview(index);
        saveToStorage();
      }
    });
    right.appendChild(chk); right.appendChild(del);
    div.appendChild(left); div.appendChild(right);
    registrationList.appendChild(div);
  });
  updatePreview(index);
}

/* 儲存固定名單（原樣保留） */
saveRolesBtn.addEventListener('click', ()=>{
  const idx = Number(eventSelect.value);
  if(isNaN(idx)) return alert('請先選取場次');
  const ev = events[idx];
  ev.roles = {
    weina: role_weina.value.trim(),
    muyu: role_muyu.value.trim(),
    speaker: role_speaker.value.trim(),
    stage1: role_stage1.value.trim(),
    stage2: role_stage2.value.trim(),
    stage3: role_stage3.value.trim(),
    stage4: role_stage4.value.trim(),
    stage5: role_stage5.value.trim()
  };
  renderRegistrationList(idx);
  status.textContent = '固定名單已儲存（僅本機）';
  saveToStorage();
});
clearRolesBtn.addEventListener('click', ()=>{
  const idx = Number(eventSelect.value);
  if(isNaN(idx)) return alert('請先選取場次');
  if(!confirm('確定要清除此場次的固定名單（維那/木魚/代說法/場控）？')) return;
  const ev = events[idx];
  ev.roles = {};
  role_weina.value = role_muyu.value = role_speaker.value =
  role_stage1.value = role_stage2.value = role_stage3.value = role_stage4.value = role_stage5.value = '';
  renderRegistrationList(idx);
  status.textContent = '固定名單已清除';
  saveToStorage();
});

/* 建立場次（加入新欄位寫入） */
createEventBtn.addEventListener('click', ()=>{
  const d = evDate.value; if(!d){ alert('請選日期'); return; }
  const hh = evHour.value; const mm = evMin.value;
  if(!hh || !mm){ alert('請選時間（時/分）'); return; }
  const time = `${hh}:${mm}`;

  let loc = (evLocationSelect.value === '其他')
    ? (evLocationOther.value || '其他')
    : evLocationSelect.value;
  if(!loc){ alert('請選集合地點'); return; }
  loc = formatLocationForDisplay(loc); // 存格式化後字串

  // 需求總人數（1~80 或留空）
  const req = evRequiredTotal.value ? Math.min(80, Math.max(1, Number(evRequiredTotal.value))) : null;

  const id = `${d}_${hh+mm}`;
  const mode = getStatusMode();
  const ev = {
    id, date:d, time, location:loc,
    roles: {}, registrants: [],
    requiredTotal: req,
    statusMode: mode,
    showReminder: !!reminderCheckbox.checked
  };
  events.push(ev);
  refreshEventSelect();
  status.textContent = '場次已建立（本機暫存）';
  saveToStorage();
});

/* 更新場次（同步新欄位） */
updateEventBtn.addEventListener('click', ()=>{
  const idx = Number(eventSelect.value); if(isNaN(idx)) return alert('請先選場次');
  const d = evDate.value; if(!d){ alert('請選日期'); return; }
  const hh = evHour.value; const mm = evMin.value;
  if(!hh || !mm){ alert('請選時間（時/分）'); return; }
  const time = `${hh}:${mm}`;

  let loc = (evLocationSelect.value === '其他')
    ? (evLocationOther.value || '其他')
    : evLocationSelect.value;
  if(!loc){ alert('請選集合地點'); return; }
  loc = formatLocationForDisplay(loc);

  const req = evRequiredTotal.value ? Math.min(80, Math.max(1, Number(evRequiredTotal.value))) : null;

  const id = `${d}_${hh+mm}`;
  events[idx].date = d;
  events[idx].time = time;
  events[idx].location = loc;
  events[idx].id = id;
  events[idx].requiredTotal = req;
  events[idx].statusMode = getStatusMode();
  events[idx].showReminder = !!reminderCheckbox.checked;

  refreshEventSelect();
  status.textContent = '場次已更新';
  saveToStorage();
});

/* 刪除場次（原樣保留） */
deleteEventBtn.addEventListener('click', ()=>{
  const idx = Number(eventSelect.value); if(isNaN(idx)) return alert('請先選場次');
  if(!confirm('確定刪除此場次？')) return;
  events.splice(idx,1);
  refreshEventSelect();
  status.textContent = '場次已刪除';
  saveToStorage();
});

/* 報名管理（原樣保留） */
addNamesBtn.addEventListener('click', ()=>{
  const idx = Number(eventSelect.value); if(isNaN(idx)) return alert('請先選場次');
  const text = namesInput.value.trim(); if(!text) return alert('請輸入姓名（逗號、頓號或換行分隔）');
  const arr = splitNamesInput(text);
  const ev = events[idx];
  ev.registrants = ev.registrants.concat(arr);
  namesInput.value = '';
  renderRegistrationList(idx);
  status.textContent = `已加入 ${arr.length} 位（已自動保存）`;
  saveToStorage();
});
clearNamesBtn.addEventListener('click', ()=>{
  const idx = Number(eventSelect.value); if(isNaN(idx)) return alert('請先選場次');
  if(!confirm('確定清空此場次所有報名者？')) return;
  events[idx].registrants = [];
  renderRegistrationList(idx);
  status.textContent = '已清空名單（已自動保存）';
  saveToStorage();
});
removeSelectedBtn.addEventListener('click', ()=>{
  const idx = Number(eventSelect.value); if(isNaN(idx)) return alert('請先選場次');
  const checks = Array.from(registrationList.querySelectorAll('input[type="checkbox"]'));
  const toRemove = [];
  checks.forEach(ch => { if(ch.checked) toRemove.push(Number(ch.dataset.idx)); });
  if(toRemove.length===0) return alert('請勾選要刪除的報名者');
  toRemove.sort((a,b)=>b-a).forEach(i => events[idx].registrants.splice(i,1));
  renderRegistrationList(idx);
  updatePreview(idx);
  status.textContent = '已刪除勾選名單（已自動保存）';
  saveToStorage();
});
</script>
<script>
/* ---------- 固定六欄：確保 <colgroup> 存在，平均欄寬 ---------- */
function ensureRegTableColgroup(){
  const table = document.querySelector('table.regTable');
  if(!table) return;
  if(!table.querySelector('colgroup')){
    const cg = document.createElement('colgroup');
    for(let i=0;i<6;i++){ cg.appendChild(document.createElement('col')); }
    table.insertBefore(cg, table.firstChild);
  }
}
function beforeRenderGridFix(){
  ensureRegTableColgroup();
}

/* ---------- 預覽：建立 6×6（最後一格統計） + 人力狀態三態 ---------- */
function updatePreview(index){
  beforeRenderGridFix();
  const ev = events[index];
  if(!ev) { renderEmptyGrid(); return; }

  // 標題：ROC 年 + 「佛化奠祭誦念」菩薩（第9點）
  const dateObj = new Date(ev.date + 'T00:00:00');
  const gYear = dateObj.getFullYear();
  const roc = gYear - 1911;
  const month = dateObj.getMonth()+1;
  const day = dateObj.getDate();
  const weekday = ['週日','週一','週二','週三','週四','週五','週六'][dateObj.getDay()];
  dynamicTitle.innerHTML = `<span class="datePart">報名${roc}/${month}/${day}(${weekday})</span><span class="titlePhrase">「佛化奠祭誦念」菩薩</span>`;

  // meta 值（時間 / 地點）
  metaTime.textContent = ev.time || '';
  // location 已存為格式化後字串（帶「・」、「樓」），保險再次格式化
  metaLocation.textContent = formatLocationForDisplay(ev.location || '');

  // 固定名單 + 一般報名
  const roleOrder = [
    {key:'weina', label:'維那'},
    {key:'muyu', label:'木魚'},
    {key:'speaker', label:'代說法'},
    {key:'stage1', label:'場控'},
    {key:'stage2', label:'場控'},
    {key:'stage3', label:'場控'},
    {key:'stage4', label:'場控'},
    {key:'stage5', label:'場控'}
  ];
  const combined = [];
  const roles = ev.roles || {};
  roleOrder.forEach(r=>{
    const name = roles[r.key];
    if(name && name.trim()){
      combined.push({ name: name.trim(), role: r.label });
    }
  });
  (ev.registrants || []).forEach(n => combined.push({ name: n, role: '' }));

  // 6x6 表格渲染
  const total = combined.length;
  const cols = 6, rows = 6;
  regBody.innerHTML = '';
  for(let r=0;r<rows;r++){
    const tr = document.createElement('tr');
    for(let c=0;c<cols;c++){
      const idxCell = r*cols + c;
      const td = document.createElement('td');
      if(idxCell === cols*rows - 1){
        td.className = 'totalCell';
        td.textContent = `合計${total}位`;
      } else {
        const item = combined[idxCell];
        if(item){
          if(item.role){
            td.innerHTML = `${escapeHtml(item.name)}<span class="roleSuffix">(${escapeHtml(item.role)})</span>`;
          } else {
            td.textContent = item.name;
          }
        } else {
          td.className = 'empty';
          td.textContent = '';
        }
      }
      tr.appendChild(td);
    }
    regBody.appendChild(tr);
  }

  // 溫馨提醒徽章（第4點）
  reminderBadge.style.display = ev.showReminder ? 'inline-block' : 'none';

  // 人力狀態（第2–3點）互斥：none/full/deficit
  const mode = ev.statusMode || 'none';
  const needTotal = Number(ev.requiredTotal || 0);
  const deficit = Math.max(0, needTotal - total);

  if(mode === 'full'){
    fullNote.style.display = 'block';
    deficitNote.style.display = 'none';
  } else if(mode === 'deficit'){
    fullNote.style.display = 'none';
    deficitNote.style.display = 'block';
    const numEl = deficitNote.querySelector('.num');
    if(numEl) numEl.textContent = String(deficit);
  } else {
    fullNote.style.display = 'none';
    deficitNote.style.display = 'none';
  }

  renderFixedRolesPreview(ev);
}

function renderFixedRolesPreview(ev){
  const roles = ev.roles || {};
  const roleOrder = [
    {key:'weina', label:'維那'},
    {key:'muyu', label:'木魚'},
    {key:'speaker', label:'代說法'},
    {key:'stage1', label:'場控'},
    {key:'stage2', label:'場控'},
    {key:'stage3', label:'場控'},
    {key:'stage4', label:'場控'},
    {key:'stage5', label:'場控'}
  ];
  let fixedHtml = '';
  roleOrder.forEach(r => {
    const n = roles[r.key];
    if(n && n.trim()){
      fixedHtml += `<div style="margin-bottom:4px;"><strong>${escapeHtml(n)}</strong><span style="font-size:12px;color:#666;margin-left:6px">(${r.label})</span></div>`;
    }
  });
  fixedRolesArea.innerHTML = fixedHtml || '<span class="small">（尚無固定名單）</span>';
}

/* ---------- 小工具 ---------- */
function escapeHtml(str){
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function renderEmptyGrid(){
  beforeRenderGridFix();
  regBody.innerHTML = '';
  for(let r=0;r<6;r++){
    const tr = document.createElement('tr');
    for(let c=0;c<6;c++){
      const td = document.createElement('td');
      if(r===5 && c===5){ td.className='totalCell'; td.textContent='合計0位'; }
      else { td.className='empty'; td.textContent=''; }
      tr.appendChild(td);
    }
    regBody.appendChild(tr);
  }
}

/* ---------- 事件：場次切換、單選狀態變更、溫馨提醒切換 ---------- */
eventSelect.addEventListener('change', ()=> {
  const idx = Number(eventSelect.value);
  if(isNaN(idx)) return;
  loadEventToForm(idx);
  updatePreview(idx);
});
statusModeRadios.forEach(r => {
  r.addEventListener('change', ()=>{
    const idx = Number(eventSelect.value);
    if(isNaN(idx)) return;
    events[idx].statusMode = r.value;
    updatePreview(idx);
    saveToStorage();
  });
});
reminderCheckbox.addEventListener('change', ()=>{
  const idx = Number(eventSelect.value);
  if(isNaN(idx)) return;
  events[idx].showReminder = !!reminderCheckbox.checked;
  updatePreview(idx);
  saveToStorage();
});

/* =========================================================================
   UA 偵測、離屏副本匯出（固定 880px、scale:2），下載策略分流
   ========================================================================= */
function isInAppBrowser(){
  const ua = navigator.userAgent || '';
  return /Line\/|FBAN|FBAV|Instagram|Twitter/i.test(ua);
}
function showUaNoticeIfNeeded(){
  if(isInAppBrowser()){
    uaNotice.style.display = 'block';
  }
}
uaDismissBtn?.addEventListener('click', ()=> uaNotice.style.display = 'none');
uaOpenExternBtn?.addEventListener('click', ()=>{
  try { window.open(location.href, '_blank'); } catch(e){}
  // 依第13點更新文案
  alert('若未成功，請使用右上或右下的「⋯」→ 以「使用預設瀏覽器開啟」或使用 Safari/Chrome 開啟本頁。');
});

/* ---------- 匯出核心：建立離屏副本並固定 880px 進行擷取 ---------- */
async function exportPNG(){
  const idx = Number(eventSelect.value);
  if(isNaN(idx)) { alert('請先選取場次'); return; }
  status.textContent = '正在生成 PNG…（固定 880px，解析度 2×）';

  const node = document.getElementById('exportArea');

  // 等待字型（若支援）
  try { if (document.fonts && document.fonts.ready) await document.fonts.ready; } catch(e){}

  // 建立離屏舞台 + 副本
  const stage = document.createElement('div');
  stage.className = 'capture-stage';
  const root = document.createElement('div');
  root.className = 'capture-root';
  const clone = node.cloneNode(true);

  // 保障表格在副本裡也有 colgroup（六欄平均）
  const cloneTable = clone.querySelector('table.regTable');
  if(cloneTable && !cloneTable.querySelector('colgroup')){
    const cg = document.createElement('colgroup');
    for(let i=0;i<6;i++){ cg.appendChild(document.createElement('col')); }
    cloneTable.insertBefore(cg, cloneTable.firstChild);
  }

  clone.style.width = '880px';
  root.appendChild(clone);
  stage.appendChild(root);
  document.body.appendChild(stage);

  // 呼叫 html2canvas（固定 scale:2）
  let dataUrl = '';
  try {
    const canvas = await html2canvas(clone, {
      scale: 2,
      useCORS: true,
      backgroundColor: null
    });
    dataUrl = canvas.toDataURL('image/png');
  } catch(err){
    console.error(err);
    status.textContent = '匯出失敗（查看 console）';
    alert('匯出 PNG 發生錯誤，請查看瀏覽器 console');
  } finally {
    stage.remove();
  }

  if(!dataUrl){ return; }

  // 分流：外部瀏覽器 → 直接下載；App 內 → Modal 長按存圖
  const filename = (outputName.value || `event-${events[idx].date}`).replace(/\s+/g,'_') + '.png';
  if(!isInAppBrowser() && supportsAnchorDownload()){
    triggerDownload(dataUrl, filename);
    status.textContent = '匯出完成，已下載 PNG';
  } else {
    openExportModalWith(dataUrl, filename);
    status.textContent = '已生成圖片，請長按上方預覽進行儲存（或使用分享/複製功能）';
  }
}

/* ---------- 能力偵測 / 下載 / 分享 / 複製 / 開新分頁 ---------- */
function supportsAnchorDownload(){
  const a = document.createElement('a');
  return 'download' in a;
}
function triggerDownload(dataUrl, filename){
  const a = document.createElement('a');
  a.href = dataUrl;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}
function dataUrlToBlob(dataUrl){
  const arr = dataUrl.split(',');
  const mime = arr[0].match(/:(.*?);/)[1];
  const bstr = atob(arr[1]);
  let n = bstr.length;
  const u8arr = new Uint8Array(n);
  while(n--){ u8arr[n] = bstr.charCodeAt(n); }
  return new Blob([u8arr], {type:mime});
}
function openExportModalWith(dataUrl, filename){
  exportImg.src = dataUrl;
  exportImg.dataset.filename = filename;

  const blob = dataUrlToBlob(dataUrl);
  const file = new File([blob], filename, { type: 'image/png' });

  if (navigator.canShare && navigator.canShare({ files: [file] })) {
    shareImageBtn.style.display = '';
    shareImageBtn.onclick = async () => {
      try {
        await navigator.share({ files: [file], title: filename, text: '報名匯出圖片' });
      } catch(e){}
    };
  } else {
    shareImageBtn.style.display = 'none';
  }

  if (navigator.clipboard && 'write' in navigator.clipboard && window.ClipboardItem) {
    copyImageBtn.style.display = '';
    copyImageBtn.onclick = async () => {
      try {
        await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
        alert('已複製圖片到剪貼簿');
      } catch(e){
        alert('複製失敗：' + (e?.message || e));
      }
    };
  } else {
    copyImageBtn.style.display = 'none';
  }

  openDataUrlBtn.onclick = ()=> {
    try { window.open(dataUrl, '_blank'); } catch(e){}
  };

  exportModal.classList.add('open');
  exportModal.setAttribute('aria-hidden','false');
}
function closeExportModal(){
  exportModal.classList.remove('open');
  exportModal.setAttribute('aria-hidden','true');
  exportImg.removeAttribute('src');
  exportImg.removeAttribute('data-filename');
}
exportModalClose?.addEventListener('click', closeExportModal);
exportModal?.addEventListener('click', (e)=>{ if(e.target === exportModal) closeExportModal(); });

/* ---------- 綁定匯出按鈕 ---------- */
downloadPreviewBtn.addEventListener('click', exportPNG);
exportBtn.addEventListener('click', exportPNG);

/* ---------- 初始化：灌入選單、載入暫存、固定六欄、UA 提示 ---------- */
function init(){
  // 時 / 分（10 分刻度）
  for(let h=0;h<24;h++){
    const o = document.createElement('option'); o.value = String(h).padStart(2,'0'); o.text = String(h).padStart(2,'0');
    evHour.appendChild(o);
  }
  ['00','10','20','30','40','50'].forEach(m=>{
    const o = document.createElement('option'); o.value = m; o.text = m;
    evMin.appendChild(o);
  });

  // 地點清單（顯示格式化後文字；值仍為原始字串，方便反查）
  evLocationSelect.innerHTML = '';
  LOCATION_LIST.forEach(loc=>{
    const o = document.createElement('option');
    o.value = loc;
    o.text = formatLocationForDisplay(loc); // 顯示美化
    evLocationSelect.appendChild(o);
  });
  evLocationSelect.addEventListener('change', ()=> {
    evLocationOther.style.display = evLocationSelect.value === '其他' ? 'block' : 'none';
  });

  // 需求總人數（允許空白；1~80）
  evRequiredTotal.innerHTML = '';
  const emptyOpt = document.createElement('option'); emptyOpt.value = ''; emptyOpt.text = '（未設定）';
  evRequiredTotal.appendChild(emptyOpt);
  for(let i=1;i<=80;i++){
    const o = document.createElement('option'); o.value = String(i); o.text = String(i);
    evRequiredTotal.appendChild(o);
  }

  // 首次載入：固定六欄、刷新畫面
  beforeRenderGridFix();
  refreshEventSelect();

  // 顯示 UA 提示（如在 LINE/FB/IG）
  showUaNoticeIfNeeded();
}
init();
</script>
