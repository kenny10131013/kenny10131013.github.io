<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>追思祝福名單匯出 PNG（6×6 固定表格 + 固定名單）</title>

<!-- html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
  /* === 原有字體與主題變數（原樣保留） ===================== */
  @font-face{
    font-family: "Microsoft JhengHei";
    src: local("Microsoft JhengHei"), local("微軟正黑體");
    font-weight: 400;
    font-style: normal;
  }
  :root{
    --accent:#b40000;
    --muted:#666;
    --panel:#ffffff;
    --highlight:#fff4e6;
    --strong-note-bg:#fff1f0;
    /* NEW: Modal/遮罩顏色 */
    --backdrop: rgba(0,0,0,.45);
  }
  *{box-sizing:border-box}
  body{font-family:"Microsoft JhengHei","Noto Sans TC","PingFang TC",Arial,sans-serif;background:#f2f4f7;margin:18px;color:#111}
  .wrap{max-width:1180px;margin:0 auto}
  h1{font-size:20px;margin:0 0 12px 0}
  .container{display:grid;grid-template-columns:420px 1fr;gap:18px}
  .card{background:var(--panel);border-radius:8px;padding:14px;border:1px solid #e6e6e6;box-shadow:0 6px 18px rgba(0,0,0,0.03)}
  label{display:block;margin:6px 0 6px;color:var(--muted);font-size:13px}
  input[type="text"], input[type="date"], select, textarea {width:100%;padding:8px;border:1px solid #d0d0d0;border-radius:6px;font-size:14px;font-family:inherit}
  textarea{resize:vertical}
  button{padding:8px 12px;border-radius:6px;border:1px solid #bbb;background:#fff;cursor:pointer;font-family:inherit}
  button.primary{background:var(--accent);color:#fff;border-color:rgba(0,0,0,0.06)}
  .small{font-size:13px;color:var(--muted)}
  .controls{display:flex;flex-direction:column;gap:12px}
  .row{display:flex;gap:8px}
  .row> *{flex:1}
  .btn-row{display:flex;gap:8px;justify-content:space-between;align-items:center}

  /* 預覽 / 匯出區（原樣保留） */
  #exportArea{width:880px;background:var(--highlight);border:3px solid #d8c9a3;padding:18px;box-sizing:border-box;color:#222}
  .headerRow{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center}
  #dynamicTitle{
    font-size:34px;
    font-weight:700;
    line-height:1.05;
    margin-bottom:6px;
    text-align:center;
  }
  #dynamicTitle .datePart{color:var(--accent);margin-right:6px}
  #dynamicTitle .titlePhrase{color:#000}

  .metaBox{border:2px solid #dcd0b8;padding:10px;background:#fff;margin-top:12px}
  .meta-left{display:flex;flex-direction:column;gap:6px;align-items:flex-start}
  .meta-left .time-line{font-size:20px;font-weight:400}
  .meta-left .loc-line{font-size:18px;color:#222}

  table.regTable{width:100%;border-collapse:collapse;margin-top:12px}
  table.regTable td{border:1px solid #9a8f7a;padding:10px;font-size:16px;height:48px;vertical-align:middle;text-align:center}
  table.regTable td.empty{color:#bbb}
  td.totalCell{font-weight:700;color:var(--accent);background:#fff6f6}
  .roleSuffix{font-size:12px;color:#444;margin-left:6px}
  .fullNote{margin-top:12px;padding:10px;background:var(--strong-note-bg);border-left:6px solid #f5c0c0;font-weight:700;color:#990000;text-align:center}
  .instruction{margin-top:8px;font-size:13px;color:var(--muted)}
  .registration-list{max-height:260px;overflow:auto;border:1px dashed #e0e0e0;padding:8px;border-radius:6px;background:#fafafa}
  .reg-item{display:flex;justify-content:space-between;padding:6px 4px;border-bottom:1px solid #eee;font-size:14px}
  .reg-item:last-child{border-bottom:none}

  .checkbox-row{display:flex;align-items:center;gap:8px}
  .role-fixed{background:#fffef7;padding:6px;border-radius:6px;margin-bottom:6px;font-size:14px}

  /* 人力已圓滿色塊（原樣保留） */
  #fullStaffWrap{
    display:flex;
    align-items:center;
    gap:8px;
    padding:10px 12px;
    border:2px solid #e5e5e5;
    border-radius:8px;
    background:#fff;
    transition:all .15s ease-in-out;
  }
  #fullStaffWrap label{
    font-size:16px;
    font-weight:700;
    color:#222;
    margin:0;
  }
  #fullStaffWrap.checked{
    background:#fff6f6;
    border-color:#f0bcbc;
    box-shadow:0 0 0 3px rgba(240,188,188,0.25) inset;
  }

  /* 右下角版本標註（原樣保留） */
  .version-tag{
    position:fixed;
    right:12px;
    bottom:10px;
    font-size:12px;
    color:#888;
    user-select:none;
    pointer-events:none;
  }

  /* RWD（原樣保留） */
  @media (max-width:1000px){
    .container{grid-template-columns:1fr; padding:8px}
    #exportArea{width:100%}
    #dynamicTitle{font-size:26px}
  }

  /* === NEW: 匯出「離屏舞台」與捕捉模式 ===================== */
  /* 說明：匯出時會複製 #exportArea 到一個畫面外的舞台，再以固定 880px 排版供 html2canvas 掃描。 */
  .capture-stage{
    position:fixed;
    left:-100000px; /* 完全離屏 */
    top:0;
    width:1px;
    height:1px;
    overflow:hidden;
    pointer-events:none;
    z-index:-1;
  }
  /* 離屏副本的根容器：統一版面寬度，避免 RWD 造成尺寸漂移 */
  .capture-root{
    width:880px;       /* 固定畫布寬 */
    margin:0;
  }
  /* 可選：在離屏副本內，強制字體與行高以穩定排版（不影響主畫面） */
  .capture-root, .capture-root *{
    font-family:"Microsoft JhengHei","Noto Sans TC","PingFang TC",Arial,sans-serif;
    line-height:1.2;
  }
  /* 若日後採用 capture-mode（鎖主畫面），這裡預留： */
  body.capture-mode #exportArea{
    width:880px !important;
  }

  /* === NEW: UA 提示條（LINE/FB/IG 內建瀏覽器） ================= */
  #uaNotice{
    display:none; /* 預設隱藏，命中 UA 後以 JS 顯示 */
    position:sticky;
    top:0;
    z-index:1000;
    background:#fff8e1;
    color:#7a3e00;
    border:1px solid #f0c070;
    border-radius:8px;
    padding:10px 12px;
    margin:0 0 12px 0;
  }
  #uaNotice .actions{
    display:flex;gap:8px;flex-wrap:wrap;margin-top:6px
  }
  #uaNotice button{
    border-color:#e0b056;
  }

  /* === NEW: 匯出預覽 Modal（長按存圖 / 分享 / 複製） ============ */
  .modal-backdrop{
    position:fixed;inset:0;background:var(--backdrop);
    display:none; /* 以 .open 切換 */
    align-items:center;justify-content:center;
    z-index:2000;
    padding:16px;
  }
  .modal-backdrop.open{display:flex}
  .modal{
    background:#fff;border-radius:12px;border:1px solid #e5e5e5;
    max-width:min(100%,960px);width:100%;
    max-height:90vh;overflow:auto;padding:14px;
    box-shadow:0 10px 30px rgba(0,0,0,.15);
  }
  .modal header{
    display:flex;align-items:center;justify-content:space-between;margin-bottom:8px
  }
  .modal header .title{font-weight:700}
  .modal .preview{
    display:flex;justify-content:center;align-items:center;margin:10px 0
  }
  .modal .preview img{
    max-width:100%;height:auto;display:block;border:1px solid #eee;border-radius:8px;background:#fff
  }
  .modal .tips{
    font-size:13px;color:#666;margin:8px 0 12px
  }
  .modal .actions{
    display:flex;gap:8px;flex-wrap:wrap
  }

  /* NEW: 無障礙隱藏文字 */
  .sr-only{
    position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;
  }
</style>
</head>
<body>
<!-- NEW: UA 提示條（僅在 LINE/FB/IG 內建瀏覽器由 JS 顯示） -->
<div id="uaNotice" role="region" aria-label="環境提示">
  <div style="font-weight:700">提示：此環境可能限制直接下載圖片</div>
  <div class="small">建議改以外部瀏覽器開啟（Safari / Chrome），或匯出後以「長按圖片存圖」方式保存。</div>
  <div class="actions" aria-label="操作">
    <button id="uaOpenExternBtn" type="button">嘗試在外部開啟</button>
    <button id="uaDismissBtn" type="button">知道了</button>
  </div>
</div>

<div class="wrap">
  <h1>追思祝福名單匯出 PNG（請以桌機電腦、手機的Chrome或是Safari瀏覽器開啟，若使用LINE的瀏覽器開啟，將會無法產生圖片）</h1>
  <div class="container">
    <!-- 控制面板（原樣） -->
    <div class="card">
      <div class="controls">
        <div>
          <div style="font-weight:700;margin-bottom:8px">建立 / 編輯場次</div>
          <label>日期</label>
          <input type="date" id="evDate" />
          <div class="row" style="margin-top:6px">
            <div>
              <label>時</label>
              <select id="evHour"></select>
            </div>
            <div>
              <label>分 (10 分刻度)</label>
              <select id="evMin"></select>
            </div>
          </div>

          <label style="margin-top:8px">集合地點</label>
          <select id="evLocationSelect"></select>
          <input id="evLocationOther" placeholder="若選「其他」，請輸入地點" style="display:none;margin-top:6px"/>

          <div style="margin-top:10px" class="btn-row">
            <button id="createEventBtn" class="primary">建立場次</button>
            <button id="updateEventBtn">更新場次</button>
            <button id="deleteEventBtn" style="color:#b00">刪除場次</button>
          </div>
          <div class="small" style="margin-top:6px">建立後會加入下方場次清單（本測試為本機暫存）</div>
        </div>

        <hr style="border:none;border-top:1px dashed #e6e6e6"/>

        <div>
          <div style="font-weight:700;margin-bottom:8px">維護：固定名單（會隨場次儲存）</div>
          <div class="small">填好一次會儲存在該場次，顯示順序：維挪 → 木魚 → 代說法 → 場控1..5</div>

          <label style="margin-top:8px">維挪姓名</label>
          <input id="role_weina" placeholder="維挪姓名 (例如 王大明)" />

          <label style="margin-top:8px">木魚姓名</label>
          <input id="role_muyu" placeholder="木魚姓名" />

          <label style="margin-top:8px">代說法姓名</label>
          <input id="role_speaker" placeholder="代說法姓名" />

          <label style="margin-top:8px">場控姓名（1）</label>
          <input id="role_stage1" placeholder="場控1" />

          <label style="margin-top:8px">場控姓名（2）</label>
          <input id="role_stage2" placeholder="場控2" />

          <label style="margin-top:8px">場控姓名（3）</label>
          <input id="role_stage3" placeholder="場控3" />

          <label style="margin-top:8px">場控姓名（4）</label>
          <input id="role_stage4" placeholder="場控4" />

          <label style="margin-top:8px">場控姓名（5）</label>
          <input id="role_stage5" placeholder="場控5" />

          <div style="margin-top:10px" class="btn-row">
            <button id="saveRolesBtn">儲存固定名單到場次</button>
            <button id="clearRolesBtn">清除固定名單</button>
          </div>
        </div>

        <hr style="border:none;border-top:1px dashed #e6e6e6"/>

        <div>
          <div style="font-weight:700;margin-bottom:8px">選取場次 / 報名管理</div>
          <label>場次列表</label>
          <select id="eventSelect"></select>

          <label style="margin-top:8px">加入報名者（逗號、頓號、換行皆視為分隔）</label>
          <textarea id="namesInput" placeholder="張三, 李四、王五 或每行一個" style="height:80px"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="addNamesBtn">加入名單</button>
            <button id="clearNamesBtn">清空名單</button>
            <button id="removeSelectedBtn">刪除勾選名單</button>
          </div>

          <div style="margin-top:10px">
            <label class="small">目前報名（固定名單會顯示於上方）</label>
            <div id="fixedRolesArea" class="role-fixed"></div>
            <div class="registration-list" id="registrationList"></div>
          </div>
        </div>

        <hr style="border:none;border-top:1px dashed #e6e6e6"/>

        <div>
          <div style="font-weight:700;margin-bottom:8px">匯出設定</div>
          <div id="fullStaffWrap" class="checkbox-row">
            <input type="checkbox" id="fullStaffCheckbox">
            <label for="fullStaffCheckbox">勾選：人力已圓滿</label>
          </div>

          <div style="margin-top:8px">
            <label>輸出檔名</label>
            <input id="outputName" placeholder="event-2025-09-02" />
          </div>
          <div style="margin-top:10px;display:flex;gap:8px">
            <button id="exportBtn" class="primary">匯出 PNG</button>
            <button id="downloadPreviewBtn">下載目前預覽</button>
          </div>
          <div id="status" class="small" style="margin-top:8px"></div>
        </div>
      </div>
    </div>

    <!-- 預覽 / 匯出區（原樣） -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:700">匯出預覽（將轉成 PNG）</div>
        <div class="small">輸出為 PNG • 解析度 2×（固定）</div>
      </div>

      <div id="exportArea" aria-label="匯出預覽">
        <div class="headerRow">
          <div id="dynamicTitle" aria-hidden="true"></div>
        </div>

        <div class="metaBox" style="margin-top:12px;display:flex;align-items:flex-start;justify-content:space-between">
          <div class="meta-left">
            <div class="time-line">集合時間：<span id="metaTime" style="font-weight:700">10:30</span></div>
            <div class="loc-line">集合地點：<span id="metaLocation" style="font-weight:700">懷愛館景行樓3F至仁1廳</span></div>
          </div>
          <div style="width:220px"></div>
        </div>

        <table class="regTable" aria-label="報名表格">
          <tbody id="regBody"></tbody>
        </table>

        <div id="fullNote" class="fullNote" style="display:none">人力已圓滿，感恩護持！</div>

        <div style="margin-top:12px;padding:10px;background:#fff7e6;border-left:6px solid #f0c070;font-weight:700;color:#7a3e00;text-align:center">
          請穿著義工服、黑襪、黑鞋、戴口罩，帶海青。
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 右下角版本標註（原樣） -->
<div class="version-tag">三寶弟子114/9/15製作</div>

<!-- NEW: 匯出預覽 Modal（不影響主畫面；僅在需要時由 JS 打開） -->
<div id="exportModal" class="modal-backdrop" aria-hidden="true" aria-label="匯出預覽圖片">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="exportModalTitle">
    <header>
      <div id="exportModalTitle" class="title">圖片預覽（長按儲存）</div>
      <button id="exportModalClose" type="button" aria-label="關閉">關閉</button>
    </header>
    <div class="preview">
      <img id="exportImg" alt="匯出圖片預覽" />
    </div>
    <div class="tips">在部分 App 內建瀏覽器（如 LINE/FB/IG），可能無法直接下載。請長按上方圖片進行儲存；或改用外部瀏覽器開啟本頁。</div>
    <div class="actions">
      <button id="shareImageBtn" type="button" style="display:none">分享圖片</button>
      <button id="copyImageBtn" type="button" style="display:none">複製到剪貼簿</button>
      <button id="openDataUrlBtn" type="button">在新分頁開啟圖片</button>
    </div>
  </div>
</div>
<script>
/* ---------- 地點下拉清單 ---------- */
const LOCATION_LIST = [
"懷愛館景仰樓1F至真1廳","懷愛館景仰樓1F至真2廳","懷愛館景仰樓1F至真3廳",
"懷愛館景仰樓2F至善1廳","懷愛館景仰樓2F至善2廳","懷愛館景仰樓2F至善3廳","懷愛館景仰樓2F至善4廳",
"懷愛館景仰樓3F至美1廳","懷愛館景仰樓3F至美2廳","懷愛館景仰樓3F至美3廳","懷愛館景仰樓3F至美4廳",
"懷愛館景行樓1F景明廳","懷愛館景行樓1F至忠1廳","懷愛館景行樓1F至忠2廳","懷愛館景行樓1F至忠3廳","懷愛館景行樓1F至忠4廳",
"懷愛館景行樓2F至孝1廳","懷愛館景行樓2F至孝2廳","懷愛館景行樓2F至孝3廳","懷愛館景行樓2F至孝4廳",
"懷愛館景行樓3F至仁1廳","懷愛館景行樓3F至仁2廳","懷愛館景行樓3F至仁3廳","懷愛館景行樓3F至仁4廳",
"懷愛館景行樓4F至愛2廳","懷愛館景行樓4F至愛3廳","懷愛館景行樓4F至愛4廳",
"其他"
];

/* ---------- DOM refs ---------- */
const evDate = document.getElementById('evDate');
const evHour = document.getElementById('evHour');
const evMin = document.getElementById('evMin');
const evLocationSelect = document.getElementById('evLocationSelect');
const evLocationOther = document.getElementById('evLocationOther');
const createEventBtn = document.getElementById('createEventBtn');
const updateEventBtn = document.getElementById('updateEventBtn');
const deleteEventBtn = document.getElementById('deleteEventBtn');
const eventSelect = document.getElementById('eventSelect');
const registrationList = document.getElementById('registrationList');
const namesInput = document.getElementById('namesInput');
const addNamesBtn = document.getElementById('addNamesBtn');
const clearNamesBtn = document.getElementById('clearNamesBtn');
const removeSelectedBtn = document.getElementById('removeSelectedBtn');
const exportBtn = document.getElementById('exportBtn');
const downloadPreviewBtn = document.getElementById('downloadPreviewBtn');
const metaTime = document.getElementById('metaTime');
const metaLocation = document.getElementById('metaLocation');
const regBody = document.getElementById('regBody');
const outputName = document.getElementById('outputName');
const status = document.getElementById('status');
const fullStaffCheckbox = document.getElementById('fullStaffCheckbox');
const fullStaffWrap = document.getElementById('fullStaffWrap');
const fullNote = document.getElementById('fullNote');
const dynamicTitle = document.getElementById('dynamicTitle');
const fixedRolesArea = document.getElementById('fixedRolesArea');

/* role inputs */
const role_weina = document.getElementById('role_weina');
const role_muyu = document.getElementById('role_muyu');
const role_speaker = document.getElementById('role_speaker');
const role_stage1 = document.getElementById('role_stage1');
const role_stage2 = document.getElementById('role_stage2');
const role_stage3 = document.getElementById('role_stage3');
const role_stage4 = document.getElementById('role_stage4');
const role_stage5 = document.getElementById('role_stage5');
const saveRolesBtn = document.getElementById('saveRolesBtn');
const clearRolesBtn = document.getElementById('clearRolesBtn');

/* ---------- NEW: Modal / UA DOM refs ---------- */
const uaNotice = document.getElementById('uaNotice');
const uaOpenExternBtn = document.getElementById('uaOpenExternBtn');
const uaDismissBtn = document.getElementById('uaDismissBtn');
const exportModal = document.getElementById('exportModal');
const exportModalClose = document.getElementById('exportModalClose');
const exportImg = document.getElementById('exportImg');
const shareImageBtn = document.getElementById('shareImageBtn');
const copyImageBtn = document.getElementById('copyImageBtn');
const openDataUrlBtn = document.getElementById('openDataUrlBtn');

/* ---------- 本地儲存（暫存/自動保存） ---------- */
const LS_KEY = 'event_png_tool_v1';
function saveToStorage(){
  try {
    localStorage.setItem(LS_KEY, JSON.stringify(events));
    status.textContent = '已自動儲存（本機）';
  } catch(e){
    console.warn('localStorage 失敗', e);
  }
}
function loadFromStorage(){
  try {
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return null;
    const parsed = JSON.parse(raw);
    if(Array.isArray(parsed)) return parsed;
  } catch(e){
    console.warn('localStorage 讀取失敗', e);
  }
  return null;
}

/* ---------- 事件本地暫存 ---------- */
let events = loadFromStorage() || [];

/* ---------- helpers: split input ---------- */
function splitNamesInput(text){
  if(!text) return [];
  const unified = text.replace(/、/g, ',').replace(/;/g, ',').replace(/\r\n/g, '\n').replace(/\r/g, '\n');
  const parts = unified.split(/[\n,]+/).map(s => s.trim()).filter(Boolean);
  return parts;
}

/* ---------- UI helper functions ---------- */
function refreshEventSelect(){
  eventSelect.innerHTML = '';
  events.forEach((ev, idx) => {
    const o = document.createElement('option'); o.value = idx; o.text = `${ev.date} ${ev.time} — ${ev.location}`;
    eventSelect.appendChild(o);
  });
  if(events.length>0){
    eventSelect.value = 0;
    loadEventToForm(0);
    updatePreview(0);
  } else {
    evDate.value = '';
    evHour.value = '';
    evMin.value = '';
    evLocationSelect.value = '';
    evLocationOther.value = '';
    evLocationOther.style.display = 'none';
    metaTime.textContent = ''; metaLocation.textContent = '';
    renderEmptyGrid();
  }
}

function loadEventToForm(index){
  const ev = events[index];
  if(!ev) return;
  evDate.value = ev.date || '';
  const [hh,mm] = (ev.time || ':').split(':');
  evHour.value = (hh || '').toString().padStart(2,'0');
  evMin.value = (mm || '').toString().padStart(2,'0');

  const found = LOCATION_LIST.includes(ev.location);
  if(found){
    evLocationSelect.value = ev.location;
    evLocationOther.style.display = 'none';
    evLocationOther.value = '';
  } else {
    evLocationSelect.value = '其他';
    evLocationOther.style.display = 'block';
    evLocationOther.value = ev.location || '';
  }

  // load fixed roles to inputs
  const roles = ev.roles || {};
  role_weina.value = roles.weina || '';
  role_muyu.value = roles.muyu || '';
  role_speaker.value = roles.speaker || '';
  role_stage1.value = roles.stage1 || '';
  role_stage2.value = roles.stage2 || '';
  role_stage3.value = roles.stage3 || '';
  role_stage4.value = roles.stage4 || '';
  role_stage5.value = roles.stage5 || '';
  outputName.value = ev.date ? `event-${ev.date}` : '';
  renderRegistrationList(index);
}

function renderRegistrationList(index){
  const ev = events[index] || {roles:{}, registrants:[]};
  registrationList.innerHTML = '';
  const roles = ev.roles || {};
  const roleOrder = [
    {key:'weina', label:'維挪'},
    {key:'muyu', label:'木魚'},
    {key:'speaker', label:'代說法'},
    {key:'stage1', label:'場控'},
    {key:'stage2', label:'場控'},
    {key:'stage3', label:'場控'},
    {key:'stage4', label:'場控'},
    {key:'stage5', label:'場控'}
  ];
  let fixedHtml = '';
  roleOrder.forEach(r => {
    const n = roles[r.key];
    if(n && n.trim()){
      fixedHtml += `<div style="margin-bottom:4px;"><strong>${escapeHtml(n)}</strong><span style="font-size:12px;color:#666;margin-left:6px">(${r.label})</span></div>`;
    }
  });
  fixedRolesArea.innerHTML = fixedHtml || '<span class="small">（尚無固定名單）</span>';

  (ev.registrants || []).forEach((name, i) => {
    const div = document.createElement('div'); div.className='reg-item';
    const left = document.createElement('div'); left.textContent = name;
    const right = document.createElement('div');
    const chk = document.createElement('input'); chk.type='checkbox'; chk.dataset.idx = i;
    const del = document.createElement('button'); del.textContent='刪除'; del.style.marginLeft='8px';
    del.addEventListener('click', ()=> {
      if(confirm(`確定刪除 ${name}？`)){
        ev.registrants.splice(i,1);
        renderRegistrationList(index);
        updatePreview(index);
        saveToStorage();
      }
    });
    right.appendChild(chk); right.appendChild(del);
    div.appendChild(left); div.appendChild(right);
    registrationList.appendChild(div);
  });
  updatePreview(index);
}

/* save fixed roles */
saveRolesBtn.addEventListener('click', ()=>{
  const idx = Number(eventSelect.value);
  if(isNaN(idx)) return alert('請先選取場次');
  const ev = events[idx];
  ev.roles = {
    weina: role_weina.value.trim(),
    muyu: role_muyu.value.trim(),
    speaker: role_speaker.value.trim(),
    stage1: role_stage1.value.trim(),
    stage2: role_stage2.value.trim(),
    stage3: role_stage3.value.trim(),
    stage4: role_stage4.value.trim(),
    stage5: role_stage5.value.trim()
  };
  renderRegistrationList(idx);
  status.textContent = '固定名單已儲存（僅本機）';
  saveToStorage();
});
clearRolesBtn.addEventListener('click', ()=>{
  const idx = Number(eventSelect.value);
  if(isNaN(idx)) return alert('請先選取場次');
  if(!confirm('確定要清除此場次的固定名單（維挪/木魚/代說法/場控）？')) return;
  const ev = events[idx];
  ev.roles = {};
  role_weina.value = role_muyu.value = role_speaker.value =
  role_stage1.value = role_stage2.value = role_stage3.value = role_stage4.value = role_stage5.value = '';
  renderRegistrationList(idx);
  status.textContent = '固定名單已清除';
  saveToStorage();
});

/* create/update/delete events */
createEventBtn.addEventListener('click', ()=>{
  const d = evDate.value; if(!d){ alert('請選日期'); return; }
  const hh = evHour.value; const mm = evMin.value;
  if(!hh || !mm){ alert('請選時間（時/分）'); return; }
  const time = `${hh}:${mm}`;
  const loc = evLocationSelect.value === '其他' ? (evLocationOther.value || '其他') : evLocationSelect.value;
  if(!loc){ alert('請選集合地點'); return; }
  const id = `${d}_${hh+mm}`;
  events.push({ id, date:d, time, location:loc, roles: {}, registrants: [] });
  refreshEventSelect();
  status.textContent = '場次已建立（本機暫存）';
  saveToStorage();
});
updateEventBtn.addEventListener('click', ()=>{
  const idx = Number(eventSelect.value); if(isNaN(idx)) return alert('請先選場次');
  const d = evDate.value; if(!d){ alert('請選日期'); return; }
  const hh = evHour.value; const mm = evMin.value;
  if(!hh || !mm){ alert('請選時間（時/分）'); return; }
  const time = `${hh}:${mm}`;
  const loc = evLocationSelect.value === '其他' ? (evLocationOther.value || '其他') : evLocationSelect.value;
  if(!loc){ alert('請選集合地點'); return; }
  const id = `${d}_${hh+mm}`;
  events[idx].date = d; events[idx].time = time; events[idx].location = loc; events[idx].id = id;
  refreshEventSelect();
  status.textContent = '場次已更新';
  saveToStorage();
});
deleteEventBtn.addEventListener('click', ()=>{
  const idx = Number(eventSelect.value); if(isNaN(idx)) return alert('請先選場次');
  if(!confirm('確定刪除此場次？')) return;
  events.splice(idx,1);
  refreshEventSelect();
  status.textContent = '場次已刪除';
  saveToStorage();
});

/* registrations management */
addNamesBtn.addEventListener('click', ()=>{
  const idx = Number(eventSelect.value); if(isNaN(idx)) return alert('請先選場次');
  const text = namesInput.value.trim(); if(!text) return alert('請輸入姓名（逗號、頓號或換行分隔）');
  const arr = splitNamesInput(text);
  const ev = events[idx];
  ev.registrants = ev.registrants.concat(arr);
  namesInput.value = '';
  renderRegistrationList(idx);
  status.textContent = `已加入 ${arr.length} 位（已自動保存）`;
  saveToStorage();
});
clearNamesBtn.addEventListener('click', ()=>{
  const idx = Number(eventSelect.value); if(isNaN(idx)) return alert('請先選場次');
  if(!confirm('確定清空此場次所有報名者？')) return;
  events[idx].registrants = [];
  renderRegistrationList(idx);
  status.textContent = '已清空名單（已自動保存）';
  saveToStorage();
});
removeSelectedBtn.addEventListener('click', ()=>{
  const idx = Number(eventSelect.value); if(isNaN(idx)) return alert('請先選場次');
  const checks = Array.from(registrationList.querySelectorAll('input[type="checkbox"]'));
  const toRemove = [];
  checks.forEach(ch => { if(ch.checked) toRemove.push(Number(ch.dataset.idx)); });
  if(toRemove.length===0) return alert('請勾選要刪除的報名者');
  toRemove.sort((a,b)=>b-a).forEach(i => events[idx].registrants.splice(i,1));
  renderRegistrationList(idx);
  updatePreview(idx);
  status.textContent = '已刪除勾選名單（已自動保存）';
  saveToStorage();
});
</script>
<script>
/* ---------- 預覽：建立 6×6（最後一格統計） ---------- */
function updatePreview(index){
  const ev = events[index];
  if(!ev) { renderEmptyGrid(); return; }

  // ROC 年 + 置中標題
  const dateObj = new Date(ev.date + 'T00:00:00');
  const gYear = dateObj.getFullYear();
  const roc = gYear - 1911;
  const month = dateObj.getMonth()+1;
  const day = dateObj.getDate();
  const weekday = ['週日','週一','週二','週三','週四','週五','週六'][dateObj.getDay()];
  dynamicTitle.innerHTML = `<span class="datePart">報名${roc}/${month}/${day}(${weekday})</span><span class="titlePhrase">追思祝福誦念菩薩</span>`;

  // meta
  metaTime.textContent = ev.time || '';
  metaLocation.textContent = ev.location || '';

  // 固定名單先、再一般報名
  const roleOrder = [
    {key:'weina', label:'維挪'},
    {key:'muyu', label:'木魚'},
    {key:'speaker', label:'代說法'},
    {key:'stage1', label:'場控'},
    {key:'stage2', label:'場控'},
    {key:'stage3', label:'場控'},
    {key:'stage4', label:'場控'},
    {key:'stage5', label:'場控'}
  ];
  const combined = [];
  const roles = ev.roles || {};
  roleOrder.forEach(r=>{
    const name = roles[r.key];
    if(name && name.trim()){
      combined.push({ name: name.trim(), role: r.label });
    }
  });
  (ev.registrants || []).forEach(n => combined.push({ name: n, role: '' }));

  const total = combined.length;
  const cols = 6, rows = 6;
  regBody.innerHTML = '';
  for(let r=0;r<rows;r++){
    const tr = document.createElement('tr');
    for(let c=0;c<cols;c++){
      const idxCell = r*cols + c;
      const td = document.createElement('td');
      if(idxCell === cols*rows - 1){
        td.className = 'totalCell';
        td.textContent = `合計${total}位`;
      } else {
        const item = combined[idxCell];
        if(item){
          if(item.role){
            td.innerHTML = `${escapeHtml(item.name)}<span class="roleSuffix">(${escapeHtml(item.role)})</span>`;
          } else {
            td.textContent = item.name;
          }
        } else {
          td.className = 'empty';
          td.textContent = '';
        }
      }
      tr.appendChild(td);
    }
    regBody.appendChild(tr);
  }
  fullNote.style.display = fullStaffCheckbox.checked ? 'block' : 'none';
  renderFixedRolesPreview(ev);
}

function renderFixedRolesPreview(ev){
  const roles = ev.roles || {};
  const roleOrder = [
    {key:'weina', label:'維挪'},
    {key:'muyu', label:'木魚'},
    {key:'speaker', label:'代說法'},
    {key:'stage1', label:'場控'},
    {key:'stage2', label:'場控'},
    {key:'stage3', label:'場控'},
    {key:'stage4', label:'場控'},
    {key:'stage5', label:'場控'}
  ];
  let fixedHtml = '';
  roleOrder.forEach(r => {
    const n = roles[r.key];
    if(n && n.trim()){
      fixedHtml += `<div style="margin-bottom:4px;"><strong>${escapeHtml(n)}</strong><span style="font-size:12px;color:#666;margin-left:6px">(${r.label})</span></div>`;
    }
  });
  fixedRolesArea.innerHTML = fixedHtml || '<span class="small">（尚無固定名單）</span>';
}

/* ---------- 小工具 ---------- */
function escapeHtml(str){
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function renderEmptyGrid(){
  regBody.innerHTML = '';
  for(let r=0;r<6;r++){
    const tr = document.createElement('tr');
    for(let c=0;c<6;c++){
      const td = document.createElement('td');
      if(r===5 && c===5){ td.className='totalCell'; td.textContent='合計0位'; }
      else { td.className='empty'; td.textContent=''; }
      tr.appendChild(td);
    }
    regBody.appendChild(tr);
  }
}

/* ---------- 事件：切換場次與人力勾選 ---------- */
eventSelect.addEventListener('change', ()=> {
  const idx = Number(eventSelect.value);
  if(isNaN(idx)) return;
  loadEventToForm(idx);
  updatePreview(idx);
});
fullStaffCheckbox.addEventListener('change', ()=> {
  const idx = Number(eventSelect.value);
  if(!isNaN(idx)) updatePreview(idx);
  fullStaffWrap.classList.toggle('checked', fullStaffCheckbox.checked);
});

/* =========================================================================
   NEW: UA 偵測、離屏副本匯出（固定 880px、scale:2），下載策略分流
   ========================================================================= */
function isInAppBrowser(){
  const ua = navigator.userAgent || '';
  return /Line\/|FBAN|FBAV|Instagram|Twitter/i.test(ua);
}
function showUaNoticeIfNeeded(){
  if(isInAppBrowser()){
    uaNotice.style.display = 'block';
  }
}
uaDismissBtn?.addEventListener('click', ()=> uaNotice.style.display = 'none');
uaOpenExternBtn?.addEventListener('click', ()=>{
  // 嘗試開新分頁（多數 App WebView 仍會攔截；此處作為友善嘗試）
  try { window.open(location.href, '_blank'); } catch(e){}
  alert('若未成功，請使用右上角「⋯」→ 以 Safari/Chrome 開啟本頁。');
});

/* ---------- 匯出核心：建立離屏副本並固定 880px 進行擷取 ---------- */
async function exportPNG(){
  const idx = Number(eventSelect.value);
  if(isNaN(idx)) { alert('請先選取場次'); return; }
  status.textContent = '正在生成 PNG…（固定 880px，解析度 2×）';

  const node = document.getElementById('exportArea');
  // 1) 等待字型（若支援）
  try { if (document.fonts && document.fonts.ready) await document.fonts.ready; } catch(e){}

  // 2) 建立離屏舞台 + 副本
  const stage = document.createElement('div');
  stage.className = 'capture-stage';
  const root = document.createElement('div');
  root.className = 'capture-root';
  const clone = node.cloneNode(true);
  // 確保克隆區的 exportArea 僅用固定寬（避免媒體查詢 100%）
  clone.style.width = '880px';
  root.appendChild(clone);
  stage.appendChild(root);
  document.body.appendChild(stage);

  // 3) 呼叫 html2canvas（固定 scale:2）
  let dataUrl = '';
  try {
    const canvas = await html2canvas(clone, {
      scale: 2,
      useCORS: true,
      backgroundColor: null
    });
    dataUrl = canvas.toDataURL('image/png');
  } catch(err){
    console.error(err);
    status.textContent = '匯出失敗（查看 console）';
    alert('匯出 PNG 發生錯誤，請查看瀏覽器 console');
  } finally {
    // 4) 清理離屏舞台
    stage.remove();
  }

  if(!dataUrl){ return; }

  // 5) 分流：外部瀏覽器 → 直接下載；App 內 → Modal 長按存圖
  const filename = (outputName.value || `event-${events[idx].date}`).replace(/\s+/g,'_') + '.png';
  if(!isInAppBrowser() && supportsAnchorDownload()){
    triggerDownload(dataUrl, filename);
    status.textContent = '匯出完成，已下載 PNG';
  } else {
    // 顯示 Modal，讓使用者長按 / 分享 / 複製
    openExportModalWith(dataUrl, filename);
    status.textContent = '已生成圖片，請長按上方預覽進行儲存（或使用分享/複製功能）';
  }
}

/* ---------- 能力偵測 ---------- */
function supportsAnchorDownload(){
  const a = document.createElement('a');
  return 'download' in a;
}

/* ---------- 下載、分享、複製、開新分頁 ---------- */
function triggerDownload(dataUrl, filename){
  const a = document.createElement('a');
  a.href = dataUrl;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}
function dataUrlToBlob(dataUrl){
  const arr = dataUrl.split(',');
  const mime = arr[0].match(/:(.*?);/)[1];
  const bstr = atob(arr[1]);
  let n = bstr.length;
  const u8arr = new Uint8Array(n);
  while(n--){ u8arr[n] = bstr.charCodeAt(n); }
  return new Blob([u8arr], {type:mime});
}

/* ---------- 匯出 Modal 控制 ---------- */
function openExportModalWith(dataUrl, filename){
  exportImg.src = dataUrl;
  exportImg.dataset.filename = filename;

  // 分享按鈕：條件顯示
  const blob = dataUrlToBlob(dataUrl);
  const file = new File([blob], filename, { type: 'image/png' });

  if (navigator.canShare && navigator.canShare({ files: [file] })) {
    shareImageBtn.style.display = '';
    shareImageBtn.onclick = async () => {
      try {
        await navigator.share({
          files: [file],
          title: filename,
          text: '報名匯出圖片'
        });
      } catch(e){}
    };
  } else {
    shareImageBtn.style.display = 'none';
  }

  if (navigator.clipboard && 'write' in navigator.clipboard && window.ClipboardItem) {
    copyImageBtn.style.display = '';
    copyImageBtn.onclick = async () => {
      try {
        await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
        alert('已複製圖片到剪貼簿');
      } catch(e){
        alert('複製失敗：' + (e?.message || e));
      }
    };
  } else {
    copyImageBtn.style.display = 'none';
  }

  openDataUrlBtn.onclick = ()=> {
    try { window.open(dataUrl, '_blank'); } catch(e){}
  };

  exportModal.classList.add('open');
  exportModal.setAttribute('aria-hidden','false');
}
function closeExportModal(){
  exportModal.classList.remove('open');
  exportModal.setAttribute('aria-hidden','true');
  exportImg.removeAttribute('src');
  exportImg.removeAttribute('data-filename');
}
exportModalClose?.addEventListener('click', closeExportModal);
exportModal?.addEventListener('click', (e)=>{
  if(e.target === exportModal) closeExportModal();
});

/* ---------- 綁定匯出按鈕 ---------- */
downloadPreviewBtn.addEventListener('click', exportPNG);
exportBtn.addEventListener('click', exportPNG);

/* ---------- 初始化：灌入選單、RWD 外觀、載入暫存 ---------- */
function init(){
  // 時、分（10 分刻度）
  for(let h=0;h<24;h++){
    const o = document.createElement('option'); o.value = String(h).padStart(2,'0'); o.text = String(h).padStart(2,'0');
    evHour.appendChild(o);
  }
  ['00','10','20','30','40','50'].forEach(m=>{
    const o = document.createElement('option'); o.value = m; o.text = m;
    evMin.appendChild(o);
  });
  // 地點清單（只灌一次）
  LOCATION_LIST.forEach(loc=>{
    const o = document.createElement('option'); o.value = loc; o.text = loc;
    evLocationSelect.appendChild(o);
  });
  evLocationSelect.addEventListener('change', ()=> {
    evLocationOther.style.display = evLocationSelect.value === '其他' ? 'block' : 'none';
  });

  refreshEventSelect();
  fullStaffWrap.classList.toggle('checked', fullStaffCheckbox.checked);

  // 顯示 UA 提示（如在 LINE/FB/IG）
  showUaNoticeIfNeeded();
}
init();
</script>

</body>
</html>
