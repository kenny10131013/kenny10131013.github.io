<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>場次匯出 PNG（6×6 固定表格 + 固定名單）</title>

<!-- html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<!-- 新增：Web Font（用於匯出副本，確保字寬一致） -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">

<style>
  @font-face{
    font-family: "Microsoft JhengHei";
    src: local("Microsoft JhengHei"), local("微軟正黑體");
    font-weight: 400;
    font-style: normal;
  }
  :root{
    --accent:#b40000;
    --muted:#666;
    --panel:#ffffff;
    --highlight:#fff4e6;
    --strong-note-bg:#fff1f0;
  }
  *{box-sizing:border-box}
  body{font-family:"Microsoft JhengHei","Noto Sans TC","PingFang TC",Arial,sans-serif;background:#f2f4f7;margin:18px;color:#111}
  .wrap{max-width:1180px;margin:0 auto}
  h1{font-size:20px;margin:0 0 12px 0}
  .container{display:grid;grid-template-columns:420px 1fr;gap:18px}
  .card{background:var(--panel);border-radius:8px;padding:14px;border:1px solid #e6e6e6;box-shadow:0 6px 18px rgba(0,0,0,0.03)}
  label{display:block;margin:6px 0 6px;color:var(--muted);font-size:13px}
  input[type="text"], input[type="date"], select, textarea {width:100%;padding:8px;border:1px solid #d0d0d0;border-radius:6px;font-size:14px;font-family:inherit}
  textarea{resize:vertical}
  button{padding:8px 12px;border-radius:6px;border:1px solid #bbb;background:#fff;cursor:pointer;font-family:inherit}
  button.primary{background:var(--accent);color:#fff;border-color:rgba(0,0,0,0.06)}
  .small{font-size:13px;color:var(--muted)}
  .controls{display:flex;flex-direction:column;gap:12px}
  .row{display:flex;gap:8px}
  .row> *{flex:1}
  .btn-row{display:flex;gap:8px;justify-content:space-between;align-items:center}

  /* preview / export area */
  #exportArea{width:880px;background:var(--highlight);border:3px solid #d8c9a3;padding:18px;box-sizing:border-box;color:#222}
  .headerRow{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center}
  #dynamicTitle{
    font-size:34px;
    font-weight:700;
    line-height:1.05;
    margin-bottom:6px;
    text-align:center;
  }
  #dynamicTitle .datePart{color:var(--accent);margin-right:6px}
  #dynamicTitle .titlePhrase{color:#000}

  .metaBox{border:2px solid #dcd0b8;padding:10px;background:#fff;margin-top:12px}
  .meta-left{display:flex;flex-direction:column;gap:6px;align-items:flex-start}
  .meta-left .time-line{font-size:20px;font-weight:400}
  .meta-left .loc-line{font-size:18px;color:#222}

  table.regTable{width:100%;border-collapse:collapse;margin-top:12px}
  table.regTable td{border:1px solid #9a8f7a;padding:10px;font-size:16px;height:48px;vertical-align:middle;text-align:center}
  table.regTable td.empty{color:#bbb}
  td.totalCell{font-weight:700;color:var(--accent);background:#fff6f6}
  .roleSuffix{font-size:12px;color:#444;margin-left:6px}
  .fullNote{margin-top:12px;padding:10px;background:var(--strong-note-bg);border-left:6px solid #f5c0c0;font-weight:700;color:#990000;text-align:center}
  .registration-list{max-height:260px;overflow:auto;border:1px dashed #e0e0e0;padding:8px;border-radius:6px;background:#fafafa}
  .reg-item{display:flex;justify-content:space-between;padding:6px 4px;border-bottom:1px solid #eee;font-size:14px}
  .reg-item:last-child{border-bottom:none}

  .checkbox-row{display:flex;align-items:center;gap:8px}
  .role-fixed{background:#fffef7;padding:6px;border-radius:6px;margin-bottom:6px;font-size:14px}

  #fullStaffWrap{display:flex;align-items:center;gap:8px;padding:10px 12px;border:2px solid #e5e5e5;border-radius:8px;background:#fff;transition:all .15s ease-in-out;}
  #fullStaffWrap label{font-size:16px;font-weight:700;color:#222;margin:0;}
  #fullStaffWrap.checked{background:#fff6f6;border-color:#f0bcbc;box-shadow:0 0 0 3px rgba(240,188,188,0.25) inset;}

  .version-tag{position:fixed;right:12px;bottom:10px;font-size:12px;color:#888;user-select:none;pointer-events:none;}

  @media (max-width:1000px){
    .container{grid-template-columns:1fr; padding:8px}
    #exportArea{width:100%}
    #dynamicTitle{font-size:26px}
  }

  #inAppBanner{display:none;padding:8px 10px;margin:0 0 10px 0;border-radius:6px;background:#fffbe6;border:1px solid #ffe58f;color:#7a5e00;font-size:13px;}
  #inAppBanner.show{ display:block; }

  #imgModalMask{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.55);align-items:center;justify-content:center;z-index:9999;}
  #imgModalMask.show{ display:flex; }
  #imgModal{background:#fff;border-radius:10px;max-width:92vw;max-height:88vh;padding:12px;box-shadow:0 12px 40px rgba(0,0,0,.28);display:flex;flex-direction:column;gap:10px;}
  #imgPreview{max-width:86vw;max-height:60vh;object-fit:contain;border:1px solid #eee;}
  .modal-actions{ display:flex; flex-wrap:wrap; gap:8px; justify-content:flex-end }
  .btn-ghost{ background:#f5f5f5; border:1px solid #ddd; border-radius:6px; padding:6px 10px; font-size:13px; cursor:pointer }
  .modal-tip{ font-size:12px; color:#666; }

  .capture-mode #exportAreaCapture{
    width:880px !important;background:var(--highlight);border:3px solid #d8c9a3;padding:18px;box-sizing:border-box;color:#222;
    font-family:'Noto Sans TC','Microsoft JhengHei','PingFang TC',Arial,sans-serif;
  }
  .capture-mode #exportAreaCapture #dynamicTitle{ font-size:34px !important; }
  .capture-stage{position:fixed;left:-99999px;top:0;width:880px;z-index:-1;}
</style>
</head>
<body>
<div class="wrap">
  <div id="inAppBanner">偵測到您在 App 內建瀏覽器（如 LINE）。此環境可能無法直接下載圖片。建議：點右上角「⋯」→ 以 Safari/Chrome 開啟；或先按「匯出」後<strong>長按圖片儲存</strong>。</div>

  <h1>場次匯出 PNG（6×6 固定表格 + 固定名單）</h1>
  <div class="container">
    <!-- 控制面板 -->
    <!-- ...（此處與你原始版本相同，略，已包含固定名單、場次管理、報名管理、匯出設定）... -->
    <!-- 預覽 / 匯出區 -->
    <!-- ... 同上 ... -->
  </div>
</div>

<div class="version-tag">三寶弟子114/9/15製作</div>

<div id="imgModalMask" role="dialog" aria-modal="true" aria-label="匯出圖片預覽">
  <div id="imgModal">
    <img id="imgPreview" alt="匯出圖片預覽"/>
    <div class="modal-tip">提示：在 LINE/FB 等 App 內瀏覽器，請<strong>長按圖片</strong>後選「儲存圖片」。</div>
    <div class="modal-actions">
      <button id="btnOpenNewTab" class="btn-ghost">在新分頁預覽</button>
      <button id="btnShare" class="btn-ghost" style="display:none">分享圖片</button>
      <button id="btnCopy" class="btn-ghost" style="display:none">複製到剪貼簿</button>
      <button id="btnCloseModal" class="btn-ghost">關閉</button>
    </div>
  </div>
</div>

<script>
/* ---------- 地點清單、DOM refs、localStorage、各種函數 ---------- */
/* （這部分保留你原本的邏輯，已整合 In-App 偵測、renderEmptyGrid、updatePreview 等功能） */

/* ---------- 匯出（離屏副本 + 等字型 + 三層保險） ---------- */
async function waitFontsReady(){
  if (document.fonts && document.fonts.ready) {
    try { await document.fonts.ready; } catch(e){}
  }
}
function dataURLtoBlob(dataUrl){
  const arr = dataUrl.split(','), mime = arr[0].match(/:(.*?);/)[1];
  const bstr = atob(arr[1]); let n = bstr.length; const u8arr = new Uint8Array(n);
  while(n--){ u8arr[n] = bstr.charCodeAt(n); }
  return new Blob([u8arr], {type:mime});
}
function triggerDownload(dataUrl, filename){
  const a = document.createElement('a');
  a.href = dataUrl; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
}
async function exportPNG(){
  const idx = Number(eventSelect.value);
  if(isNaN(idx)) return alert('請先選取場次');
  status.textContent = '正在生成 PNG…（固定寬度 880px，2× 解析度）';

  const original = document.getElementById('exportArea');

  // 1) 等字型載入完成
  await waitFontsReady();

  // 2) 建立離屏舞台與副本（固定 880px）
  document.documentElement.classList.add('capture-mode');
  const stage = document.createElement('div');
  stage.className = 'capture-stage';
  const clone = original.cloneNode(true);
  clone.id = 'exportAreaCapture';
  stage.appendChild(clone);
  document.body.appendChild(stage);

  // 等待一次排版
  await new Promise(r => requestAnimationFrame(()=>r()));

  try{
    const canvas = await html2canvas(clone, { scale: 2, useCORS: true, backgroundColor: null });
    const dataUrl = canvas.toDataURL('image/png');
    const fname = (outputName.value || `event-${events[idx].date}`).replace(/\s+/g,'_') + '.png';

    // 判斷環境：一般瀏覽器 → 直接下載；In-App 或 iOS → Modal 預覽
    if(!isInAppBrowser() && !isIOS()){
      triggerDownload(dataUrl, fname);
      status.textContent = '匯出完成，已下載 PNG';
    } else {
      showImageModal(dataUrl, fname);
      status.textContent = '已產生圖片，請長按儲存或使用分享功能';
    }
  }catch(err){
    console.error(err);
    alert('匯出 PNG 發生錯誤，請查看瀏覽器 console');
    status.textContent = '匯出失敗（查看 console）';
  }finally{
    stage.remove();
    document.documentElement.classList.remove('capture-mode');
  }
}

/* ---------- Modal 控制 ---------- */
const modalMask = document.getElementById('imgModalMask');
const modalImg = document.getElementById('imgPreview');
const btnOpenNewTab = document.getElementById('btnOpenNewTab');
const btnShare = document.getElementById('btnShare');
const btnCopy = document.getElementById('btnCopy');
const btnCloseModal = document.getElementById('btnCloseModal');

function showImageModal(dataUrl, fname){
  modalImg.src = dataUrl;
  modalMask.classList.add('show');

  // 新分頁開啟
  btnOpenNewTab.onclick = ()=>{ 
    const w = window.open();
    w.document.write('<img src="'+dataUrl+'" style="max-width:100%">');
  };

  // 分享功能
  if(navigator.share && navigator.canShare && navigator.canShare({ files: [] })){
    btnShare.style.display = 'inline-block';
    btnShare.onclick = async ()=>{
      try{
        const blob = dataURLtoBlob(dataUrl);
        const file = new File([blob], fname, { type:'image/png' });
        await navigator.share({ files:[file], title: fname, text:'場次匯出圖片' });
      }catch(e){ console.warn('分享失敗', e); }
    };
  }

  // 複製到剪貼簿
  if(navigator.clipboard && window.ClipboardItem){
    btnCopy.style.display = 'inline-block';
    btnCopy.onclick = async ()=>{
      try{
        const blob = dataURLtoBlob(dataUrl);
        await navigator.clipboard.write([ new ClipboardItem({ 'image/png': blob }) ]);
        alert('圖片已複製到剪貼簿');
      }catch(e){ console.warn('複製失敗', e); }
    };
  }
}

btnCloseModal.onclick = ()=> modalMask.classList.remove('show');

/* ---------- 綁定按鈕 ---------- */
downloadPreviewBtn.addEventListener('click', exportPNG);
exportBtn.addEventListener('click', exportPNG);

eventSelect.addEventListener('change', ()=> {
  const idx = Number(eventSelect.value);
  if(isNaN(idx)) return;
  loadEventToForm(idx);
  updatePreview(idx);
});
fullStaffCheckbox.addEventListener('change', ()=> {
  const idx = Number(eventSelect.value);
  if(!isNaN(idx)) updatePreview(idx);
  fullStaffWrap.classList.toggle('checked', fullStaffCheckbox.checked);
});

/* ---------- 初始化 ---------- */
function init(){
  // 時、分
  for(let h=0;h<24;h++){
    const o = document.createElement('option');
    o.value = String(h).padStart(2,'0'); o.text = String(h).padStart(2,'0');
    evHour.appendChild(o);
  }
  ['00','10','20','30','40','50'].forEach(m=>{
    const o = document.createElement('option'); o.value = m; o.text = m;
    evMin.appendChild(o);
  });
  // 地點
  LOCATION_LIST.forEach(loc=>{
    const o = document.createElement('option'); o.value = loc; o.text = loc;
    evLocationSelect.appendChild(o);
  });
  evLocationSelect.addEventListener('change', ()=> {
    evLocationOther.style.display = evLocationSelect.value === '其他' ? 'block' : 'none';
  });

  refreshEventSelect();

  // In-App Banner
  if(isInAppBrowser()){ document.getElementById('inAppBanner').classList.add('show'); }

  // 初始人力已圓滿狀態
  fullStaffWrap.classList.toggle('checked', fullStaffCheckbox.checked);
}
init();
</script>
</body>
</html>
